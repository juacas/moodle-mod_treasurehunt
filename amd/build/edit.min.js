// This file is part of Moodle - http:// moodle.org/.
//
// Moodle is free software: you can redistribute it and/or modify.
// it under the terms of the GNU General Public License as published by.
// the Free Software Foundation, either version 3 of the License, or.
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,.
// but WITHOUT ANY WARRANTY; without even the implied warranty of.
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the.
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License.
// along with Moodle.  If not, see <http:// www.gnu.org/licenses/>.
/**
 * @module mod_treasurehunt/edit
 * @package mod_treasurehunt
 * @copyright 2016 onwards Adrian Rodriguez Fernandez <huorwhisp@gmail.com>,
 *            Juan Pablo de Castro <jpdecastro@tel.uva.es>
 * @author Adrian Rodriguez <huorwhisp@gmail.com>
 * @author Juan Pablo de Castro <jpdecastro@tel.uva.es>*
 * @license http:// www.gnu.org/copyleft/gpl.html GNU GPL v3 or later.
 */
define([
  "jquery",
  "jqueryui",
  "mod_treasurehunt/jquery-ui-touch-punch",
  "core/notification",
  "mod_treasurehunt/ol",
  "core/ajax",
  "mod_treasurehunt/osm-geocoder",
  "mod_treasurehunt/ol3-layerswitcher",
  "core/str",
], function (e, t, o, i, n, a, r, s, l) {
  function d(t, o, s, l, d, c) {
    var u = new n.proj.Projection("EPSG:3857"),
      g = null,
      p = !0;
    if (void 0 !== c && null != c) {
      if (null != c.custombackgroundurl) {
        var h = n.proj.transformExtent(c.bbox, "EPSG:4326", "EPSG:3857");
        if (!c.geographic) {
          h[2], h[0];
          var f = h[3] - h[1],
            m = (h[2] + h[0]) / 2,
            v = (h[3] + h[1]) / 2,
            y = Math.round(f / c.imgheight),
            b = Math.round(c.imgwidth * y),
            w = Math.round(c.imgheight * y);
          h = [m - b / 2, v - w / 2, m + b / 2, v + w / 2];
        }
        g = new n.layer.Image({
          title: c.layername,
          type: c.layertype,
          source: new n.source.ImageStatic({
            url: c.custombackgroundurl,
            imageExtent: h,
          }),
          opacity: 1,
        });
      } else if (null != c.wmsurl) {
        var P = {
          source: new n.source.TileWMS({ url: c.wmsurl, params: c.wmsparams }),
          type: c.layertype,
          title: c.layername,
        };
        if (
          null != c.bbox[0] &&
          null != c.bbox[1] &&
          null != c.bbox[2] &&
          null != c.bbox[3]
        ) {
          var F = n.proj.transformExtent(c.bbox, "EPSG:4326", "EPSG:3857");
          P.extent = F;
        }
        g = new n.layer.Tile(P);
      }
      p = c.geographic;
    }
    var I,
      S,
      C,
      x,
      k = { roads: {} },
      E = new n.source.Vector({ projection: "EPSG:3857" }),
      A = new n.source.Vector({ projection: "EPSG:3857" }),
      G = !1,
      T = !1,
      z = !1,
      B = {},
      j = 1,
      _ = new n.layer.Vector({
        source: new n.source.Vector({ projection: "EPSG:3857" }),
      });
    let L;
    function M(t, o, i, n, a, r) {
      var s,
        l = e(t).get([i]),
        d = e(l).attr("roadid");
      (s = Math.abs(e(l).index('li[roadid="' + d + '"]') - o)),
        e(l).attr("stageposition", s),
        e(l).find(".sortable-number").text(s),
        e(l).hasClass("ui-selected") && (I = s),
        (function (e, t, o, i, n, a) {
          var r,
            s = i.getFeatureById(e);
          s || ((s = n.getFeatureById(e).clone()).setId(e), i.addFeature(s));
          if (
            (s.setProperties({ stageposition: t }),
            "empty" !== s.get("idFeaturesPolygons"))
          ) {
            r = s.get("idFeaturesPolygons").split(",");
            for (var l = 0, d = r.length; l < d; l++)
              a.getSource()
                .getFeatureById(r[l])
                .setProperties({ stageposition: t });
          }
        })(
          parseInt(e(l).attr("stageid"), 10),
          s,
          parseInt(e(l).attr("roadid"), 10),
          n,
          a,
          r
        );
    }
    p &&
      (e('<div id="searchcontainer">').appendTo(e("#controlpanel")),
      e(
        '<input type="search" placeholder="' +
          s.searchlocation +
          '" class="searchaddress"/>'
      ).appendTo(e("#searchcontainer")),
      e('<span class="ui-icon  ui-icon-search searchicon"></span>').prependTo(
        e("#searchcontainer")
      ),
      e(
        '<span class="ui-icon  ui-icon-closethick closeicon invisible"></span>'
      ).appendTo(e("#searchcontainer"))),
      e('<ul id="stagelist"/>').prependTo(e("#stagelistpanel")),
      e("#stagelist")
        .sortable({
          handle: ".handle",
          tolerance: "pointer",
          zIndex: 9999,
          opacity: 0.5,
          forcePlaceholderSize: !0,
          cursorAt: { top: -7 },
          cursor: "n-resize",
          axis: "y",
          items: "li:not(:hidden , .blocked)",
          helper: "clone",
          start: function (t, o) {
            var i = o.item.attr("roadid"),
              n = o.item.index('li[roadid="' + i + '"]'),
              a = e(this).data("ui-sortable").scrollParent,
              r = a[0].scrollHeight - a[0].clientHeight - o.helper.height();
            o.item.data("start_pos", n), e(this).data("maxScrollTop", r);
          },
          sort: function (t, o) {
            var i = e(this).data("ui-sortable").scrollParent,
              n = e(this).data("maxScrollTop");
            i.scrollTop() > n && i.scrollTop(n);
          },
          update: function (t, o) {
            var i,
              n = o.item.data("start_pos"),
              a = o.item.attr("roadid"),
              r = o.item.index('li[roadid="' + a + '"]'),
              s = e(this).children('li[roadid="' + a + '"]'),
              l = e(s).length;
            if (n !== r) {
              if (n < r)
                for (i = n; i <= r; i++) M(s, l, i, E, A, k.roads[a].vector);
              else for (i = r; i <= n; i++) M(s, l, i, E, A, k.roads[a].vector);
              se(), (G = !0);
            }
          },
        })
        .disableSelection(),
      e('<ul id="roadlist"/>').appendTo(e("#roadlistpanel")),
      (window.app = {});
    var V = window.app;
    (V.generateResizableControl = function (e) {
      var t = e || {},
        o = document.createElement("button"),
        i = document.createElement("div");
      (o.innerHTML = "<>"),
        (o.id = "egrip"),
        (i.className = "ol-control ol-unselectable egrip-container"),
        i.appendChild(o),
        n.control.Control.call(this, { element: i, target: t.target });
    }),
      n.inherits(V.generateResizableControl, n.control.Control);
    var O = new n.style.Style({
        fill: new n.style.Fill({ color: "rgba(100, 100, 255, 0.2)" }),
        stroke: new n.style.Stroke({
          color: "rgba(100, 100, 255, 0.5)",
          width: 2,
        }),
        image: new n.style.Circle({
          radius: 5,
          fill: new n.style.Fill({ color: "#ffcc33" }),
          stroke: new n.style.Stroke({ color: "#000000", width: 2 }),
        }),
        text: new n.style.Text({
          textAlign: "center",
          scale: 1.3,
          fill: new n.style.Fill({ color: "#fff" }),
          stroke: new n.style.Stroke({ color: "#6C0492", width: 3.5 }),
        }),
      }),
      D = new n.style.Style({
        fill: new n.style.Fill({ color: "rgba(200, 100, 100, 0.2)" }),
        stroke: new n.style.Stroke({ color: "rgba(255, 0, 0, 0.5)", width: 3 }),
        image: new n.style.Circle({
          radius: 5,
          fill: new n.style.Fill({ color: "#ffcc33" }),
          stroke: new n.style.Stroke({ color: "#000000", width: 2 }),
        }),
        text: new n.style.Text({
          textAlign: "center",
          scale: 1.3,
          fill: new n.style.Fill({ color: "#fff" }),
          stroke: new n.style.Stroke({ color: "#C3000B", width: 3.5 }),
        }),
        zIndex: "Infinity",
      }),
      H = new n.layer.Vector({
        source: new n.source.Vector({ projection: "EPSG:3857" }),
        visible: !1,
      }),
      N = new n.layer.Group({
        title: s.basemaps,
        layers: [
          new n.layer.Tile({
            title: s.aerialmap,
            type: "base",
            visible: !1,
            source: new n.source.BingMaps({
              key:
                "AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",
              imagerySet: "AerialWithLabels",
              maxZoom: 19,
            }),
          }),
          new n.layer.Tile({
            title: s.roadmap,
            type: "base",
            visible: !0,
            source: new n.source.OSM(),
          }),
        ],
      });
    null != g && (c.onlybase && N.getLayers().clear(), N.getLayers().push(g));
    var W = document.getElementById("popup"),
      q = document.getElementById("popup-content"),
      R = document.getElementById("popup-closer"),
      K = new n.Overlay({
        element: W,
        autoPan: !0,
        autoPanAnimation: { duration: 250 },
      });
    R.onclick = function () {
      return K.setPosition(void 0), R.blur(), !1;
    };
    var J = new n.control.LayerSwitcher(),
      X = new n.Map({
        layers: [N, H],
        overlays: [K],
        projection: u,
        renderer: "canvas",
        target: "mapedit",
        view: new n.View({ center: [0, 0], zoom: 2, minZoom: 2 }),
        controls: n.control
          .defaults()
          .extend([
            J,
            new V.generateResizableControl({
              target: document.getElementById("stagelistpanel"),
            }),
          ]),
      });
    X.on("click", function (e) {
      Z.getActive() ||
        Y.getActive() ||
        (null !== c && !c.geographic) ||
        (function (e) {
          var t = e.coordinate,
            o = n.proj.toLonLat(t, X.getView().getProjection()),
            i = n.coordinate.toStringHDMS(o),
            a =
              '<a target="street" href="http://maps.google.com/?cbll=' +
              o[1] +
              "," +
              o[0] +
              '&cbp=12,20.09,,0,5&layer=c"><img src="pix/my_location.png" width="16" /></a>';
          (q.innerHTML = "<code>" + a + i + "</code>"), K.setPosition(t);
        })(e);
    }),
      J.showPanel(),
      e("#stagelistpanel").resizable({
        handles: { e: e("#egrip") },
        resize: function (e, t) {
          t.size.height = t.originalSize.height;
        },
        stop: function (e, t) {
          X.updateSize();
        },
        cancel: "",
      });
    var Y = {
      init: function () {
        (this.select = new n.interaction.Select({
          filter: function (e) {
            return !!B[e.getId()];
          },
          style: function (e) {
            var t = new n.style.Fill({ color: "rgba(255,100,100,0.4)" }),
              o = new n.style.Stroke({ color: "rgba(255, 0, 0, 1)", width: 4 });
            return [
              new n.style.Style({
                image: new n.style.Circle({ fill: t, stroke: o, radius: 5 }),
                fill: t,
                stroke: o,
                text: new n.style.Text({
                  text: "" + e.get("stageposition"),
                  textAlign: "center",
                  scale: 1.3,
                  fill: new n.style.Fill({ color: "#fff" }),
                  stroke: new n.style.Stroke({
                    color: "rgba(255, 0, 0, 1)",
                    width: 3.5,
                  }),
                }),
                zIndex: "Infinity",
              }),
            ];
          },
        })),
          X.addInteraction(this.select),
          (this.modify = new n.interaction.Modify({
            features: this.select.getFeatures(),
            style: new n.style.Style({
              image: new n.style.Circle({
                radius: 5,
                fill: new n.style.Fill({ color: "#3399CC" }),
                stroke: new n.style.Stroke({ color: "#000000", width: 2 }),
              }),
            }),
            deleteCondition: function (e) {
              return (
                n.events.condition.shiftKeyOnly(e) &&
                n.events.condition.singleClick(e)
              );
            },
          })),
          X.addInteraction(this.modify),
          this.setEvents();
      },
      setEvents: function () {
        (x = this.select.getFeatures()),
          this.select.on("change:active", function () {
            x.clear(), te();
          }),
          this.select.on("select", function () {
            x.getLength() > 0 ? e("#removefeature").prop("disabled", !1) : te();
          }),
          this.modify.on("modifyend", function (e) {
            se(),
              (function (e, t, o, i) {
                e.forEach(function (e) {
                  var a,
                    r = e.get("stageid"),
                    s = o.getFeatureById(r);
                  s ||
                    ((s = t.getFeatureById(r).clone()).setId(r),
                    o.addFeature(s));
                  for (
                    var l = new n.geom.MultiPolygon([]),
                      d = 0,
                      c = (a = s.get("idFeaturesPolygons").split(",")).length;
                    d < c;
                    d++
                  )
                    l.appendPolygon(
                      i.getSource().getFeatureById(a[d]).getGeometry().clone()
                    );
                  s.setGeometry(l);
                });
              })(e.features, A, E, k.roads[S].vector),
              (G = !0);
          });
      },
      getActive: function () {
        return !(!this.select.getActive() || !this.modify.getActive());
      },
      setActive: function (e) {
        this.select.setActive(e), this.modify.setActive(e);
      },
    };
    Y.init();
    var Z = {
      init: function () {
        X.addInteraction(this.Polygon),
          this.Polygon.setActive(!1),
          this.setEvents();
      },
      Polygon: new n.interaction.Draw({
        source: H.getSource(),
        type: "Polygon",
        style: new n.style.Style({
          fill: new n.style.Fill({ color: "rgba(0, 0, 0, 0.05)" }),
          stroke: new n.style.Stroke({ color: "#FAC30B", width: 2 }),
          image: new n.style.Circle({
            radius: 5,
            fill: new n.style.Fill({ color: "#ffcc33" }),
            stroke: new n.style.Stroke({ color: "#000000", width: 2 }),
          }),
          zIndex: "Infinity",
        }),
      }),
      setEvents: function () {
        this.Polygon.on("drawend", function (t) {
          (z = !1),
            T
              ? (H.getSource().clear(), (T = !1))
              : (t.feature.setProperties({
                  roadid: S,
                  stageid: C,
                  stageposition: I,
                }),
                (B[j] = !0),
                t.feature.setId(j),
                j++,
                k.roads[S].vector.getSource().addFeature(t.feature),
                (function (t, o, i) {
                  var n = t.get("stageid"),
                    a = t.get("roadid"),
                    r = i.getFeatureById(n);
                  r ||
                    ((r = o.getFeatureById(n).clone()).setId(n),
                    i.addFeature(r));
                  "empty" === r.get("idFeaturesPolygons")
                    ? (r.setProperties({ idFeaturesPolygons: "" + t.getId() }),
                      (function (t, o) {
                        if (
                          (e('#stagelist li[stageid="' + t + '"]')
                            .children(".handle, .nohandle")
                            .addClass("validstage")
                            .removeClass("invalidstage"),
                          o)
                        ) {
                          e("label[for='addradio']").removeClass(
                            "highlightbutton"
                          ),
                            0 ===
                              e("#stagelist li[roadid='" + o + "']").find(
                                ".invalidstage"
                              ).length &&
                              e("#erremptystage").addClass("invisible");
                        }
                      })(n, a))
                    : r.setProperties({
                        idFeaturesPolygons:
                          r.get("idFeaturesPolygons") + "," + t.getId(),
                      });
                  r.getGeometry().appendPolygon(t.getGeometry());
                })(t.feature, A, E),
                H.getSource().clear(),
                se(),
                (G = !0));
        }),
          this.Polygon.on("drawstart", function (e) {
            z = !0;
          });
      },
      getActive: function () {
        return this.Polygon.getActive();
      },
      setActive: function (e) {
        e ? this.Polygon.setActive(!0) : this.Polygon.setActive(!1),
          (X.getTargetElement().style.cursor = e ? "none" : "");
      },
    };
    e(document).keyup(function (e) {
      27 === e.keyCode && z && ((T = !0), Z.Polygon.finishDrawing());
    }),
      Z.init(),
      ae(),
      ne();
    var Q = new n.interaction.Snap({ source: H.getSource() });
    function U(e) {
      var t = e.get("stageposition");
      return (
        isNaN(t) || (D.getText().setText("" + t), O.getText().setText("" + t)),
        B[e.getId()] ? [D] : [O]
      );
    }
    function $(t, o) {
      var i = 0;
      for (var n in t)
        if (k.roads.hasOwnProperty(n)) {
          (i = 1), t[(S = n)].blocked ? ie() : oe(), ce(S, t[S].vector, o);
          break;
        }
      0 === i &&
        (ie(),
        e("#addroad").addClass("highlightbutton").blur(),
        e("#stagelistpanel").addClass("invisible"),
        o.updateSize());
    }
    function ee(t, o) {
      (e('#stagelist li[stageid="' + t + '"]')
        .children(".handle,.nohandle")
        .addClass("invalidstage")
        .removeClass("validstage"),
      o) &&
        (e("label[for='addradio']").addClass("highlightbutton"),
        e("#stagelist li[roadid='" + o + "']").length >= 2 &&
          e("#erremptystage").removeClass("invisible"));
    }
    function te() {
      e("#removefeature").prop("disabled", !0);
    }
    function oe() {
      e("#addstage").prop("disabled", !1);
    }
    function ie() {
      e("#addstage").prop("disabled", !0);
    }
    function ne() {
      e("#editmode").prop("disabled", !0),
        e("#drawmode").prop("disabled", !0),
        ae();
    }
    function ae() {
      e("#editmode").removeClass("selectedbutton").prop("z-index", "Infinity"),
        e("#drawmode")
          .removeClass("selectedbutton")
          .prop("z-index", "Infinity"),
        e("#navmode")
          .prop("disabled", !1)
          .addClass("selectedbutton")
          .blur()
          .prop("z-index", 999),
        Z.setActive(!1),
        Y.setActive(!1);
    }
    function re() {
      e("#editmode").addClass("selectedbutton").blur().prop("z-index", 999),
        e("#drawmode")
          .removeClass("selectedbutton")
          .prop("z-index", "Infinity"),
        e("#navmode").removeClass("selectedbutton").prop("z-index", "Infinity"),
        Z.setActive(!1),
        Y.setActive(!0);
    }
    function se() {
      e("#savestage").prop("disabled", !1);
    }
    function le(e, t, o) {
      var i = e.getView();
      o
        ? i.fit(o, { duration: 700 })
        : i.animate({ zoom: 19, center: t, duration: 700 });
    }
    function de(t) {
      t.length > 0
        ? (e("#stagelistpanel").removeClass("invisible"), X.updateSize())
        : (e("#stagelistpanel").addClass("invisible"), X.updateSize()),
        t.length < 2
          ? (e("#addstage").addClass("highlightbutton").blur(),
            e("#errvalidroad").removeClass("invisible"),
            e("#erremptystage").addClass("invisible"))
          : t.find(".invalidstage").length > 0
          ? (e("#addstage").removeClass("highlightbutton"),
            e("#errvalidroad").addClass("invisible"),
            e("#erremptystage").removeClass("invisible"))
          : (e("#addstage").removeClass("highlightbutton"),
            e("#errvalidroad").addClass("invisible"),
            e("#erremptystage").addClass("invisible"));
    }
    function ce(t, o, i) {
      e("#stagelist li").removeClass("ui-selected").hide();
      var a = e("#stagelist li[roadid='" + t + "']");
      a.show(),
        de(a),
        e("#roadlist li[roadid='" + t + "']").addClass("ui-selected"),
        i.getLayers().forEach(function (e) {
          e instanceof n.layer.Vector && e.setVisible(!1);
        }),
        o.setVisible(!0),
        o.getSource().getFeatures().length > 0 &&
          le(i, null, o.getSource().getExtent());
    }
    function ue(e, t) {
      var o = "editstage.php?cmid=" + t + "&id=" + e;
      window.location.href = o;
    }
    function ge(e, t) {
      var o = "editstage.php?cmid=" + t + "&roadid=" + e;
      window.location.href = o;
    }
    function pe(e, t) {
      var o = "editroad.php?cmid=" + t + "&id=" + e;
      window.location.href = o;
    }
    function he(e) {
      var t = "editroad.php?cmid=" + e;
      window.location.href = t;
    }
    function fe(t, o, n, r, s) {
      e(".treasurehunt-editor-loader").show(),
        a
          .call([
            {
              methodname: "mod_treasurehunt_delete_road",
              args: { roadid: t, treasurehuntid: r, lockid: s },
            },
          ])[0]
          .done(function (a) {
            if ((e(".treasurehunt-editor-loader").hide(), a.status.code))
              i.alert("Error", a.status.msg, "Continue");
            else {
              !(function (t) {
                var o = e('#roadlist li[roadid="' + t + '"]');
                if (o.length > 0) {
                  var i = e('#stagelist li[roadid="' + t + '"]');
                  o.remove(), i.remove();
                }
              })(t),
                X.removeLayer(k.roads[t].vector),
                delete k.roads[t],
                $(k.roads, X),
                ne();
              for (var r = n.getFeatures(), s = 0; s < r.length; s++)
                if (t === r[s].get("roadid")) {
                  var l = o.getFeatureById(r[s].getId());
                  l && o.removeFeature(l), n.removeFeature(r[s]);
                }
            }
          })
          .fail(function (t) {
            e(".treasurehunt-editor-loader").hide(),
              console.log(t),
              i.exception(t);
          });
    }
    function me(t, o, n, r, s, l) {
      e(".treasurehunt-editor-loader").show(),
        a
          .call([
            {
              methodname: "mod_treasurehunt_delete_stage",
              args: { stageid: t, treasurehuntid: s, lockid: l },
            },
          ])[0]
          .done(function (a) {
            if ((e(".treasurehunt-editor-loader").hide(), a.status.code))
              i.alert("Error", a.status.msg, "Continue");
            else {
              var s,
                l = !1,
                d = o.getFeatureById(t);
              if (
                ((function (t, o, i, n) {
                  var a = e('#stagelist li[stageid="' + t + '"]');
                  if (a.length > 0) {
                    var r = a.attr("roadid"),
                      s = a.index('li[roadid="' + r + '"]');
                    a.remove();
                    var l = e("#stagelist li[roadid='" + r + "']");
                    de(l);
                    for (var d = l.length, c = 0; c <= s - 1; c++)
                      M(l, d, c, o, i, n);
                  }
                })(t, o, n, r),
                d
                  ? ("empty" !== d.get("idFeaturesPolygons") &&
                      (l = d.get("idFeaturesPolygons").split(",")),
                    o.removeFeature(d))
                  : ("empty" !==
                      (d = n.getFeatureById(t)).get("idFeaturesPolygons") &&
                      (l = d.get("idFeaturesPolygons").split(",")),
                    n.removeFeature(d)),
                l)
              )
                for (var c = 0, u = l.length; c < u; c++)
                  (s = r.getSource().getFeatureById(l[c])),
                    r.getSource().removeFeature(s);
            }
          })
          .fail(function (t) {
            e(".treasurehunt-editor-loader").hide(),
              console.log(t),
              i.exception(t);
          });
    }
    function ve(t, o, r, s, l, d) {
      e(".treasurehunt-editor-loader").show();
      var c,
        u = new n.format.GeoJSON(),
        g = t.getFeatures(),
        p = [];
      g.forEach(function (e) {
        (c = e.clone()).unset("idFeaturesPolygons"),
          c.unset("name"),
          c.unset("clue"),
          c.unset("treasurehuntid"),
          c.setId(e.getId()),
          p.push(c);
      });
      var h = u.writeFeaturesObject(p, {
        dataProjection: "EPSG:4326",
        featureProjection: "EPSG:3857",
      });
      a.call([
        {
          methodname: "mod_treasurehunt_update_stages",
          args: { stages: h, treasurehuntid: r, lockid: d },
        },
      ])[0]
        .done(function (n) {
          var a;
          (e(".treasurehunt-editor-loader").hide(), n.status.code)
            ? i.alert("Error", n.status.msg, "Continue")
            : (t.forEachFeature(function (e) {
                (a = o.getFeatureById(e.getId())).setProperties(
                  e.getProperties()
                ),
                  a.setGeometry(e.getGeometry());
              }),
              t.clear(),
              e("#savestage").prop("disabled", !0),
              (G = !1),
              "function" == typeof s && l instanceof Array && s.apply(null, l));
        })
        .fail(function (t) {
          e(".treasurehunt-editor-loader").hide(),
            console.log(t),
            i.alert("Error", t.message, "Continue");
        });
    }
    X.addInteraction(Q),
      (function (t) {
        a.call([
          {
            methodname: "mod_treasurehunt_fetch_treasurehunt",
            args: { treasurehuntid: t },
          },
        ])[0]
          .done(function (t) {
            if ((e(".treasurehunt-editor-loader").hide(), t.status.code))
              i.alert("Error", t.status.msg, "Continue");
            else {
              t.treasurehunt.stages;
              var o,
                a,
                r = new n.format.GeoJSON(),
                s = t.treasurehunt.roads;
              Array.isArray(s) || (s = Object.values(s)),
                s.forEach(function (t) {
                  (t.blocked = 1 == t.blocked),
                    (function (t, o, i) {
                      if (e('#roadlist li[roadid="' + t + '"]').length < 1) {
                        e('<li roadid="' + t + '" blocked="' + i + '"/>')
                          .appendTo(e("#roadlist"))
                          .addClass("ui-corner-all")
                          .append("<div class='roadname'>" + o + "</div>")
                          .append(
                            "<div class='modifyroad'><span class='ui-icon ui-icon-trash'></span><span class='ui-icon ui-icon-pencil'></span></div>"
                          );
                      }
                    })(t.id, t.name, t.blocked),
                    (a = r.readFeatures(t.stages, {
                      dataProjection: "EPSG:4326",
                      featureProjection: "EPSG:3857",
                    })),
                    A.addFeatures(a),
                    delete t.stages,
                    (o = new n.layer.Vector({
                      source: new n.source.Vector({ projection: "EPSG:3857" }),
                      updateWhileAnimating: !0,
                      style: U,
                    })),
                    a.forEach(function (i) {
                      null === i.getGeometry() &&
                        i.setGeometry(new n.geom.MultiPolygon([]));
                      for (
                        var a = i.getGeometry().getPolygons(),
                          r = "empty",
                          s = i.get("stageposition"),
                          l = i.get("name"),
                          d = i.get("clue"),
                          c = i.getId(),
                          u = t.blocked,
                          g = 0;
                        g < a.length;
                        g++
                      ) {
                        var p = new n.Feature(i.getProperties());
                        p.setProperties({ stageid: c });
                        var h = a[g];
                        p.setGeometry(h),
                          p.setId(j),
                          (r = 0 === g ? j : r + "," + j),
                          j++,
                          o.getSource().addFeature(p);
                      }
                      i.setProperties({ idFeaturesPolygons: "" + r }),
                        (function (t, o, i, n, a, r) {
                          if (
                            e('#stagelist li[stageid="' + t + '"]').length < 1
                          ) {
                            var s = e(
                              '<li stageid="' +
                                t +
                                '" roadid="' +
                                o +
                                '" stageposition="' +
                                i +
                                '"/>'
                            ).appendTo(e("#stagelist"));
                            s
                              .addClass("ui-corner-all")
                              .append("<div class='stagename'>" + n + "</div>")
                              .append(
                                "<div class='modifystage'><span class='ui-icon ui-icon-pencil'></span><span class='ui-icon ui-icon-info' data-id='#dialoginfo" +
                                  t +
                                  "'><div id='dialoginfo" +
                                  t +
                                  "' title='" +
                                  n +
                                  "'>" +
                                  a +
                                  "</div></span></div>"
                              ),
                              r
                                ? s
                                    .addClass("blocked")
                                    .prepend(
                                      "<div class='nohandle validstage'><span class='ui-icon ui-icon-locked'></span><span class='sortable-number'>" +
                                        i +
                                        "</span></div>"
                                    )
                                : (s.prepend(
                                    "<div class='handle validstage'><span class='ui-icon ui-icon-arrowthick-2-n-s'></span><span class='sortable-number'>" +
                                      i +
                                      "</span></div>"
                                  ),
                                  s
                                    .children(".modifystage")
                                    .prepend(
                                      "<span class='ui-icon ui-icon-trash'></span>"
                                    )),
                              e("#dialoginfo" + t).dialog({
                                maxHeight: 500,
                                autoOpen: !1,
                              });
                          } else
                            console.log(
                              "El li con " +
                                t +
                                " no ha podido crearse porque ya existia uno"
                            );
                        })(c, t.id, s, l, d, u),
                        0 === a.length && ee(c);
                    }),
                    (t.vector = o),
                    X.addLayer(o),
                    (k.roads[t.id] = t);
                }),
                e("#stagelist li")
                  .sort(function (t, o) {
                    var i = parseInt(e(t).attr("stageposition")),
                      n = parseInt(e(o).attr("stageposition"));
                    return i < n ? 1 : i > n ? -1 : 0;
                  })
                  .appendTo(e("#stagelist")),
                void 0 !== k.roads[l]
                  ? ((S = l),
                    k.roads[S].blocked ? ie() : oe(),
                    ce(S, k.roads[S].vector, X))
                  : $(k.roads, X);
            }
          })
          .fail(function (t) {
            e(".treasurehunt-editor-loader").hide(),
              console.log(t),
              i.exception(t);
          });
      })(o),
      e(".searchaddress")
        .autocomplete({
          minLength: 4,
          source: function (e, t) {
            var o = e.term;
            L && L.abort(),
              (L = r
                .search(o)
                .done((e) => {
                  if (0 !== e.length) {
                    for (var o = [], i = 0, n = e.length; i < n; i++) {
                      var a, r;
                      (a = e[i].lat), (r = e[i].lon);
                      var s = {
                        value: e[i].display_name,
                        latitude: a,
                        longitude: r,
                        boundingbox: e[i].boundingbox,
                      };
                      o[i] = s;
                    }
                    t(o);
                  } else t();
                })
                .fail(() => {
                  t();
                })
                .always(() => {
                  L = null;
                }));
          },
          select: function (e, t) {
            if (t.item.boundingbox) {
              var o = [];
              (o[0] = parseFloat(t.item.boundingbox[2])),
                (o[1] = parseFloat(t.item.boundingbox[0])),
                (o[2] = parseFloat(t.item.boundingbox[3])),
                (o[3] = parseFloat(t.item.boundingbox[1])),
                (o = n.proj.transformExtent(o, "EPSG:4326", "EPSG:3857")),
                le(X, null, o);
            } else {
              var i = n.proj.fromLonLat([t.item.longitude, t.item.latitude]);
              le(X, i);
            }
          },
          autoFocus: !0,
        })
        .on("click", function () {
          e(this).autocomplete("search", e(this).value);
        }),
      (e.ui.autocomplete.prototype._resizeMenu = function () {
        this.menu.element.outerWidth(this.element.outerWidth());
      }),
      e("#drawmode")
        .css("position", "relative")
        .on("click", function () {
          e("#drawmode")
            .addClass("selectedbutton")
            .blur()
            .prop("z-index", "Infinity"),
            e("#editmode")
              .removeClass("selectedbutton")
              .prop("z-index", "auto"),
            e("#navmode").removeClass("selectedbutton").prop("z-index", "auto"),
            Y.setActive(!1),
            Z.setActive(!0);
        }),
      e("#editmode").css("position", "relative").on("click", re),
      e("#navmode").css("position", "relative").on("click", ae),
      e("#addstage").on("click", function () {
        G ? ve(E, A, o, ge, [S, t], d) : ge(S, t);
      }),
      e("#addroad").on("click", function () {
        G ? ve(E, A, o, he, [t], d) : he(t);
      }),
      e("#removefeature").on("click", function () {
        i.confirm(
          s.areyousure,
          s.removewarning,
          s.confirm,
          s.cancel,
          function () {
            !(function (e, t, o, i) {
              e.forEach(function (e) {
                var a,
                  r,
                  s = e.get("stageid"),
                  l = e.get("roadid"),
                  d = o.getFeatureById(s);
                d ||
                  ((d = t.getFeatureById(s).clone()).setId(s), o.addFeature(d));
                for (
                  var c = new n.geom.MultiPolygon([]),
                    u = 0,
                    g = (a = d.get("idFeaturesPolygons").split(",")).length;
                  u < g;
                  u++
                )
                  a[u] != e.getId()
                    ? c.appendPolygon(
                        i.getSource().getFeatureById(a[u]).getGeometry().clone()
                      )
                    : (r = u);
                d.setGeometry(c),
                  c.getPolygons().length
                    ? (a.splice(r, 1),
                      d.setProperties({ idFeaturesPolygons: a.join() }))
                    : (d.setProperties({ idFeaturesPolygons: "empty" }),
                      ee(s, l));
              });
            })(x, A, E, k.roads[S].vector),
              (function (e, t) {
                e.forEach(function (e) {
                  t.getSource().removeFeature(e);
                }),
                  e.clear();
              })(x, k.roads[S].vector),
              te(),
              se(),
              (G = !0);
          }
        );
      }),
      e("#savestage").on("click", function () {
        ve(E, A, o, null, null, d);
      }),
      e("#stagelist").on("click", ".ui-icon-info, .ui-icon-alert", function () {
        var t = e(this).data("id");
        e(t).dialog("open"), e(".ui-dialog :button").blur();
      }),
      e("#stagelist").on("click", ".ui-icon-trash", function () {
        var t = e(this).parents("li");
        i.confirm(
          s.areyousure,
          s.removewarning,
          s.confirm,
          s.cancel,
          function () {
            me(parseInt(t.attr("stageid")), E, A, k.roads[S].vector, o, d);
          }
        );
      }),
      e("#stagelist").on("click", ".ui-icon-pencil", function () {
        var i = parseInt(e(this).parents("li").attr("stageid"));
        G ? ve(E, A, o, ue, [i, t], d) : ue(i, t);
      });
    e("#stagelist").on("click", "li", function (t) {
      e(t.target).is(".handle ,.nohandle, .ui-icon , .sortable-number")
        ? t.preventDefault()
        : (e(this)
            .addClass("ui-selected")
            .siblings()
            .removeClass("ui-selected"),
          (I = parseInt(e(this).attr("stageposition"))),
          (C = parseInt(e(this).attr("stageid"))),
          (function (e, t, o, i, n, a) {
            t.getSource().clear(), i.clear(), (B = {});
            var r = n.getFeatureById(o);
            if (r || (r = a.getFeatureById(o)))
              if ("empty" !== r.get("idFeaturesPolygons")) {
                for (
                  var s = r.get("idFeaturesPolygons").split(","),
                    l = 0,
                    d = s.length;
                  l < d;
                  l++
                )
                  t
                    .getSource()
                    .addFeature(e.getSource().getFeatureById(s[l]).clone()),
                    (B[s[l]] = !0);
                t.getSource().getFeatures().length &&
                  le(X, null, t.getSource().getExtent());
              } else e.changed();
            else e.changed();
          })(k.roads[S].vector, _, C, x, E, A),
          e("#drawmode").prop("disabled", !1),
          e("#editmode").prop("disabled", !1),
          re(),
          e(this).find(".invalidstage").length > 0
            ? e("label[for='addradio']").addClass("highlightbutton")
            : e("label[for='addradio']").removeClass("highlightbutton"),
          z && ((T = !0), Z.Polygon.finishDrawing()));
    }),
      e("#roadlist").on("click", "li", function (t) {
        if (e(t.target).is(".ui-icon")) t.preventDefault();
        else {
          e(this).addClass("ui-selected").siblings().removeClass("ui-selected"),
            (B = {}),
            z && ((T = !0), Z.Polygon.finishDrawing()),
            (S = e(this).attr("roadid"));
          var o,
            i = e(this).attr("blocked");
          parseInt(i) || "true" === i ? ie() : oe(),
            ce(S, k.roads[S].vector, X),
            ne(),
            (o =
              "fixed" === e("header[role=banner]").css("position")
                ? parseInt(e(".treasurehunt-editor").offset().top) -
                  parseInt(e("header[role=banner]").outerHeight(!0))
                : parseInt(e(".treasurehunt-editor").offset().top)),
            e("html, body").animate({ scrollTop: o }, 500);
        }
      }),
      e("#roadlist").on("click", ".ui-icon-pencil", function () {
        var i = parseInt(e(this).parents("li").attr("roadid"));
        G ? ve(E, A, o, pe, [i, t], d) : pe(i, t);
      }),
      e("#roadlist").on("click", ".ui-icon-trash", function () {
        var t = e(this).parents("li");
        i.confirm(
          s.areyousure,
          s.removeroadwarning,
          s.confirm,
          s.cancel,
          function () {
            fe(parseInt(t.attr("roadid")), E, A, o, d);
          }
        );
      }),
      X.on("pointermove", function (e) {
        if (!e.dragging && !Z.getActive() && Y.getActive()) {
          var t = X.getEventPixel(e.originalEvent),
            o = X.forEachFeatureAtPixel(t, function (e, t) {
              if (B[e.getId()]) {
                var o = !1;
                return (
                  x.forEach(function (t) {
                    e === t && (o = !0);
                  }),
                  !o
                );
              }
              return !1;
            });
          X.getTargetElement().style.cursor = o ? "pointer" : "";
        }
      }),
      e(document).on("touchend", ".ui-dialog-titlebar-close", function () {
        e(this).parent().siblings(".ui-dialog-content").dialog("close");
      }),
      e(".searchaddress").on("input", function () {
        var t;
        e(".closeicon")[((t = this.value), t ? "removeClass" : "addClass")](
          "invisible"
        );
      }),
      e(".closeicon").on("touchstart click", function (t) {
        t.preventDefault(),
          e(this).addClass("invisible"),
          e(".searchaddress").val("").change().autocomplete("close");
      }),
      (window.onbeforeunload = function (e) {
        var t = s.savewarning;
        e = e || window.event;
        if (G) return e && (e.returnValue = t), t;
      });
  }
  return {
    edittreasurehunt: function (e, t, o, i, n) {
      var a = [
          "stage",
          "road",
          "aerialmap",
          "roadmap",
          "basemaps",
          "add",
          "modify",
          "save",
          "remove",
          "searchlocation",
          "savewarning",
          "removewarning",
          "areyousure",
          "removeroadwarning",
          "confirm",
          "cancel",
        ],
        r = a.map(function (e) {
          return { key: e, component: "treasurehunt" };
        });
      l.get_strings(r).done(function (r) {
        for (var s = [], l = 0; l < a.length; l++) s[a[l]] = r[l];
        if (null != n && null !== n.custombackgroundurl) {
          var c = new Image();
          c.addEventListener("load", function () {
            (n.imgwidth = this.naturalWidth),
              (n.imgheight = this.naturalHeight),
              d(e, t, s, o, i, n);
          }),
            (c.src = n.custombackgroundurl);
        } else d(e, t, s, o, i, n);
      });
    },
  };
});
