/**
 * @module    mod_treasurehunt/viewgpx
 * @package   mod_treasurehunt
 * @copyright 2016 onwards Adrian Rodriguez Fernandez <huorwhisp@gmail.com>, Juan Pablo de Castro <jpdecastro@tel.uva.es>
 * @author Adrian Rodriguez <huorwhisp@gmail.com>
 * @author Juan Pablo de Castro <jpdecastro@tel.uva.es>
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","mod_treasurehunt/ol","mod_treasurehunt/ol3-layerswitcher","core/str"],(function(e,t,r,n){console.log("Loading viewgpx.js with jquery "+e().jquery);var o=30,a=0;return{addgpxlayer:function(e,r,n,o,a,i){var l=function(e,r){var n=null,o=e.getLayers();o.forEach((function(e){e.get("title")==r&&(n=e)})),n||(n=new t.layer.Group({title:r,layers:[]}),e.addLayer(n));return n}(e,i);return c([a],r,e,l,null),l},creategpxviewer:function(e,t,r,a,l){console.log("Creating gpxviewer.");var c=["aerialmap","roadmap","basemaps","searchlocation","trackviewer","pegmanlabel"],s=c.map((function(e){return{key:e,component:"treasurehunt"}}));if(o=l,"global"==r)r=users_param;n.get_strings(s).done((function(n){console.log("I18N strings loaded.");for(var o=[],l=0;l<c.length;l++)o[c[l]]=n[l];if(null!=a&&null!==a.custombackgroundurl){var s=new Image;s.addEventListener("load",(function(){a.imgwidth=this.naturalWidth,a.imgheight=this.naturalHeight,i(e,t,o,r,a)})),s.src=a.custombackgroundurl}else i(e,t,o,r,a)}))},createCoordsOverlay:function(r="#mappage",n="css/ol-popup.css",o=""){e("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet",href:n});var a=e('<div id="popupmarker" class="ol-popup"><a href="#" id="popup-closer" class="ol-popup-closer"></a><div id="popup-content"></div></div>');e(r).append(a);var i=e("#popupmarker"),l=(e("#popup-content"),e("#popup-closer")),c=i.get(0),s=null,u=this.createPegmanLink,p=new t.Overlay({element:c,autoPan:!0,autoPanAnimation:{duration:250}});return l.click((function(){return p.setPosition(void 0),clearTimeout(s),l.blur(),e("#popup-content").html(""),!1})),t.events.listen(p,t.Object.getChangeEventType(t.Overlay.Property.POSITION),(function(t){var r=this.getPosition();if(clearTimeout(s),r){var n=u(r,p.getMap(),o);e("#popup-content").html(n),s=setTimeout((()=>{e("#popup-closer").trigger("click")}),2e3)}}),p),i.hover((function(){clearTimeout(s)})),p},createPegmanLink:function(e,r,n){var o=t.proj.toLonLat(e,r.getView().getProjection()),a=t.coordinate.toStringHDMS(o);return'<a target="street" href="http://maps.google.com/?cbll='+o[1]+","+o[0]+'&cbp=12,20.09,,0,5&layer=c"><img src="pix/my_location.png" width="16" />'+n+"<br/></a><code>"+a+"</code>"}};function i(r,n,i,l,u){console.log("Init gpx viewer.");var p="EPSG:3857",g=null;if(void 0!==u&&null!=u){if(null!=u.custombackgroundurl){var m=function(e,r,n=!1){var o=t.proj.transformExtent(e.bbox,"EPSG:4326",r);if(1==e.preserveaspectratio){o[2],o[0];var a=o[3]-o[1],i=(o[2]+o[0])/2,l=(o[3]+o[1])/2,c=Math.round(a/e.imgheight),s=Math.round(e.imgwidth*c),u=Math.round(e.imgheight*c);n?o=[i-s/2,l-u/2,i+s/2,l+u/2]:(o=[o[0],o[1],o[0]+s,o[1]+u],console.log("Using bottom-left as reference."+o))}return o}(u,p,!1);g=new t.layer.Image({title:u.layername,type:u.layertype,source:new t.source.ImageStatic({url:u.custombackgroundurl,imageExtent:m}),opacity:1})}else if(null!=u.wmsurl){let e={type:u.layertype,title:u.layername,name:u.layername};if("wms"===u.layerservicetype?e.source=new t.source.TileWMS({url:u.wmsurl,params:u.wmsparams}):"tiled"===u.layerservicetype?e.source=new t.source.XYZ({url:u.wmsurl}):"arcgis"===u.layerservicetype&&(e.source=new t.source.TileArcGISRest({url:u.wmsurl})),u.bbox[0]&&u.bbox[1]&&u.bbox[2]&&u.bbox[3]){let r=t.proj.transformExtent(u.bbox,"EPSG:4326",p);e.extent=r}(g=new t.layer.Tile(e)).set("name",u.layername)}u.geographic}var d=new t.layer.Group({title:i.basemaps,layers:[new t.layer.Tile({title:i.aerialmap,type:"base",visible:!1,source:new t.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})}),new t.layer.Tile({title:i.roadmap,type:"base",visible:!0,source:new t.source.OSM})]});null!==g&&(u.onlybase&&d.getLayers().clear(),d.getLayers().push(g));var y=new t.layer.Group({title:i.trackviewer,layers:[]}),h=(new t.layer.Heatmap({title:"Heatmap",source:new t.source.Vector({url:"gpx.php?id="+r+"&userid=24",format:new t.format.GPX}),blur:20,radius:10}),new t.control.LayerSwitcher),f=new t.Map({layers:[d,y],renderer:"canvas",target:document.getElementById("mapgpx"),view:new t.View({center:[0,0],zoom:2,minZoom:2}),controls:t.control.defaults().extend([h])});console.log("Map created in mapgpx!"),h.showPanel();var w=new t.interaction.Select({style:function(e){return s(e,w.getLayer(e).iconurl,!0)}});f.addInteraction(w),c(l,r,f,y,h);var v=new t.Overlay({element:document.getElementById("info")});function b(e,r,n,o){var a=[],i="";if(r.forEachFeatureAtPixel(e,(function(e){a.push(e)})),a.length>0){var l,c,s=[];for(l=0,c=a.length;l<c;++l)s.push(a[l].get("desc"));i=s.join(", ")||"(unknown)",f.getTarget().style.cursor="pointer"}else i=function(e,r,n){var o=t.proj.toLonLat(e,r.getView().getProjection()),a=t.coordinate.toStringHDMS(o);return'<a target="street" href="http://maps.google.com/?cbll='+o[1]+","+o[0]+'&cbp=12,20.09,,0,5&layer=c"><img src="pix/my_location.png" width="16" />'+n+"<br/></a><code>"+a+"</code>"}(n,f,o),f.getTarget().style.cursor="";return i}f.addOverlay(v),f.on("pointermove",(function(e){e.dragging})),f.on("click",(function(t){!function(t){var r=v.getElement(),n=t.coordinate;e(r).popover("dispose"),v.setPosition(n),e(r).popover({placement:"top",animation:!1,html:!0,content:b(f.getEventPixel(t.originalEvent),f,n,i.pegmanlabel)}),e(r).popover("show")}(t)}));var x=null;e("#refreshtracks").change((function(){e(this).is(":checked")?(a=0,e("#timecircle").show(),x=setInterval((function(){e("#timecircle").text(o-a++%o)}),1e3)):(e("#timecircle").hide(),clearInterval(x))}))}function l(e,t,r){var n=e.getView();r?n.fit(r,{duration:700}):n.animate({zoom:19,center:t,duration:700})}function c(r,n,i,c,u){var p=null;r.forEach((function(r){var g=new t.source.Vector({url:"gpx.php?id="+n+"&userid="+r.id,format:new t.format.GPX}),m=r.pic.indexOf('<img src="')+10,d=r.pic.indexOf('"',m),y=r.pic.substring(m,d),h=new t.layer.Vector({source:g,title:r.pic+""+r.fullname+"</img>",style:function(e){return s(e,y,!1)}});h.iconurl=y,setInterval((function(){e("#refreshtracks").is(":checked")&&(a=0,g.clear(),g.refresh())}),1e3*o),h.on("change:visible",(function(){if(this.getVisible()){var e=this.getSource().getExtent();null!==(e=function(e){if(!(e instanceof Array)||4!=e.length)return null;if(e[0]===1/0||e[1]===1/0||e[2]===1/0||e[3]===1/0)return null;return e}(e))&&l(i,null,e)}})),g.on("change",(function(){if(!e("#refreshtracks").is(":checked")){var t=g.getExtent();null===p?p=t:(p[0]=Math.min(p[0],t[0]),p[1]=Math.min(p[1],t[1]),p[2]=Math.max(p[2],t[2]),p[3]=Math.max(p[3],t[3])),l(i,null,p)}}),this),c.getLayers().push(h),u&&u.renderPanel()}))}function s(e,r,n){var o=[new t.style.Style({stroke:new t.style.Stroke({color:"rgba(255,255,255,0.8)",width:6+2*n}),zIndex:1+4*n}),new t.style.Style({stroke:new t.style.Stroke({color:"#ff0000",width:1+n,lineDash:[10,8]}),fill:new t.style.Fill({color:"rgba(255,0,0,0.5)"}),zIndex:2+4*n}),new t.style.Style({image:new t.style.Circle({radius:3+2*n,stroke:new t.style.Stroke({color:"white",width:1+n}),fill:new t.style.Fill({color:"red"})}),geometry:function(e){var r=e.getGeometry().getCoordinates()[0];return new t.geom.MultiPoint(r)},zIndex:3+4*n})],a=e.getGeometry().getLastCoordinate();return o.push(new t.style.Style({geometry:new t.geom.Point(a),image:new t.style.Icon({src:r,anchor:[.75,.5],rotateWithView:!1}),zIndex:4+4*n})),o}}));