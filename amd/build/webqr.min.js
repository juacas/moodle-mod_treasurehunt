/**
 * integrates teh QRSCanner.
 *
 * @package   mod_treasurehunt
 * @copyright 2018 Juan Pablo de Castro <jpdecastro@tel.uva.es>
 * @author Juan Pablo de Castro <jpdecastro@tel.uva.es>
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/notification","core/str","mod_treasurehunt/instascan"],(function(e,t,i,n){var a=-1,o=null,r=null;return{getDetectedCameras:()=>o,setup:function(){},enableTest:function(t){var i={};if(document.cookie.split(";").forEach((function(e){var t=e.split("=");t[1]&&(i[t[0].trim()]=t[1].trim())})),"Done"!=i.QRScanPassed){var n=function(i){document.cookie="QRScanPassed = Done",this.unloadQR((function(){e("#QRStatusDiv").html(t)}))}.bind(this);e("#idbuttonnextcam").click((()=>this.setnextwebcam(this.testFormReport.bind(this)))),this.loadQR(n,this.testFormReport.bind(this))}else e("#QRStatusDiv").html(t)},testFormReport:function(i){if("string"==typeof i)e("#QRvalue").text(i),e("#previewQR").hide();else if("object"==typeof i)if("NotAllowedError"==i.name||0==i.code)t.addNotification({message:e("#errorQR").text(),type:"error"}),e("#previewQR").hide(),e("#QRStatusDiv").hide();else{let t=e("#previewQRvideo"),n=t.closest("div"),a=n.width(),o=n.height();t.width()/t.height()>a/o?t.width(a):t.height(o),t.css("display","block");let r=i.camera;null!==i.cameras[r].name&&e("#QRvalue").text(i.cameras[r].name),e("#previewQR").show();let s=this.getnextwebCam();s!=r?(null!==i.cameras[s].name&&e("#idbuttonnextcam").text(s+":"+i.cameras[s].name),e("#idbuttonnextcam").show()):e("#idbuttonnextcam").hide()}},enableEditForm:function(){e("#id_generateQR").click(this.handleGenerateQR.bind(this)),e("#id_stopQR").click(this.handleStopQR.bind(this)),e("#id_scanQR").click(this.handleScanEditStage.bind(this)),e("#idbuttonnextcam").click((()=>this.setnextwebcam(this.editFormReport.bind(this))))},handleGenerateQR:function(){var t=e("#id_qrtext").val();if(""!=t){var i="https://quickchart.io/qr?size=500&text="+e("#id_qrtext").val();e("#outQRCode").text(""),e("#outQRCode").prepend(e("<img>",{id:"theQRImg",src:i,width:"150px",align:"left",title:t}))}else e("#QRStatusDiv").text("Enter text in QRText field.");return!1}.bind(this),handleStopQR:function(){return this.unloadQR(),e("#QRvalue").text(""),e("#previewQR").hide(),e("#id_stopQR").hide(),e("#id_scanQR").show(),!1},handleScanEditStage:function(){return this.loadQR(function(t){e("#id_qrtext").val(t),this.unloadQR(),e("#QRvalue").text(""),e("#id_stopQR").hide(),e("#id_scanQR").show(),e("#previewQR").hide()}.bind(this),this.editFormReport.bind(this)),e("#previewQR").show(),e("#previewQRdiv").show(),e("#id_stopQR").show(),e("#id_scanQR").hide(),!1},editFormReport:function(t){if("string"==typeof t)e("#QRvalue").text(t),e("#id_stopQR").hide(),e("#id_scanQR").show(),e("#previewQRdiv").hide(),e("#idbuttonnextcam").hide();else if("object"==typeof t)if(0==t.code)i.get_string("warnqrscannererror","treasurehunt"),e("#outQRCode").text("Camera access error!");else{let i=t.camera;e("#QRvalue").text(i+":"+t.cameras[i].name);let n=(i+1)%t.cameras.length;n!=i?(e("#idbuttonnextcam").text(n+":"+t.cameras[n].name),e("#idbuttonnextcam").show()):e("#idbuttonnextcam").hide()}},unloadQR:function(t){if(void 0===r)return;r.stop().then((function(){console.info("camera stopped")})),a=-1,e("#previewQRvideo").hide(),"function"==typeof t&&t("")},loadQR:function(t,i){let s=e("#previewQRvideo");s.show(),(r=new n.Scanner({video:s.get(0),mirror:!1})).addListener("scan",t),n.Camera.getCameras().then((function(e){(o=e).length>0?(a=0,r.start(o[a]).then((function(){i({camera:a,cameras:o})})).catch((function(e){i(e)}))):console.error("No cameras found.")})).catch((function(e){i(e)}))},getnextwebCam:function(){return null===o||-1===a?0:(a+1)%o.length},getbackCam:function(){var e=this.getnextwebCam();if(null!==o&&o.length>1)for(var t=0;t<o.length;t++)null!==o[t].name&&-1!=o[t].name.toLowerCase().indexOf("back")&&(e=t);return e},setnextwebcam:function(e){let t=this.getnextwebCam();if(a!=t)if(null!==o)try{this.selectCamera(o,t,e)}catch(t){console.error(t),e(t.message)}else n.Camera.getCameras().then((function(i){this.selectCamera(i,t,e)})).catch((function(t){console.error(t),e(t.message)}))},selectCamera:function(t,i,n){if(t.length>0){if(-1==a&&t.length>1)for(var o=0;o<t.length;o++)null!==t[o].name&&-1!=t[o].name.toLowerCase().indexOf("back")&&(i=o);a=i,r.start(t[a]).then((function(){let i=e("#previewQRvideo"),o=i.closest("div"),r=o.width(),s=o.height();i.width()/i.height()>r/s?i.width(r):i.height(s),i.css("display","block"),n({camera:a,cameras:t})})).catch((function(e){r.stop(),console.error(e),n("Error activating camera: "+e.message)}))}else console.error("No cameras found."),n("No cameras found.")}}}));