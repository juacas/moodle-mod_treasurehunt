/**
 * integrates teh QRSCanner.
 *
 * @package   mod_treasurehunt
 * @copyright 2018 Juan Pablo de Castro <jpdecastro@tel.uva.es>
 * @author Juan Pablo de Castro <jpdecastro@tel.uva.es>
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
function selectCamera(e,t,n){if(e.length>0){if(-1==camera&&e.length>1)for(var i=0;i<e.length;i++)null!==e[i].name&&-1!=e[i].name.toLowerCase().indexOf("back")&&(t=i);camera=t,scanner.start(e[camera]).then((function(){let t=$("#previewQRvideo"),i=t.closest("div"),a=i.width(),o=i.height();t.width()/t.height()>a/o?t.width(a):t.height(o),t.css("display","block"),n({camera:camera,cameras:e})})).catch((function(e){scanner.stop(),console.error(e),n("Error activating camera: "+e.message)}))}else console.error("No cameras found."),n("No cameras found.")}define(["jquery","core/notification","core/str"],(function(e,t,n){var i=-1,a=null,o=null;return{setup:function(){},enableTest:function(t){var n={};document.cookie.split(";").forEach((function(e){var t=e.split("=");t[1]&&(n[t[0].trim()]=t[1].trim())})),"Done"!=n.QRScanPassed?this.loadQR((function(n){document.cookie="QRScanPassed = Done",this.unloadQR((function(){e("#QRStatusDiv").html(t)})).bind(this)}),this.testFormReport.bind(this)):e("#QRStatusDiv").html(t)},testFormReport:function(n){if("string"==typeof n)e("#QRvalue").text(n),e("#previewQR").hide();else if("object"==typeof n)if(0==n.code)t.addNotification({message:e("#errorQR").text(),type:"error"}),e("#previewQR").hide(),e("#QRStatusDiv").hide();else{let t=e("#previewQRvideo"),i=t.closest("div"),a=i.width(),o=i.height();t.width()/t.height()>a/o?t.width(a):t.height(o),t.css("display","block");let r=n.camera;null!==n.cameras[r].name&&e("#QRvalue").text(n.cameras[r].name),e("#previewQR").show();let s=this.getnextwebCam();s!=r?(null!==n.cameras[s].name&&e("#idbuttonnextcam").text(s+":"+n.cameras[s].name),e("#idbuttonnextcam").show()):e("#idbuttonnextcam").hide()}},enableForm:function(){e("#id_generateQR").click(this.handleGenerateQR.bind(this)),e("#id_stopQR").click(this.handleStopQR.bind(this)),e("#id_scanQR").click(this.handleScanEditStage.bind(this))},handleGenerateQR:function(){var t=e("#id_qrtext").val();if(""!=t){var n="https://chart.googleapis.com/chart?cht=qr&chs=500x500&chl="+e("#id_qrtext").val();e("#outQRCode").text(""),e("#outQRCode").prepend(e("<img>",{id:"theQRImg",src:n,width:"150px",align:"left",title:t}))}else e("#QRStatusDiv").text("Enter text in QRText field.");return!1}.bind(this),handleStopQR:function(){return this.unloadQR(),e("#QRvalue").text(""),e("#previewQR").hide(),e("#id_stopQR").hide(),e("#id_scanQR").show(),!1},handleScanEditStage:function(){return this.loadQR(function(t){e("#id_qrtext").val(t),this.unloadQR(),e("#QRvalue").text(""),e("#id_stopQR").hide(),e("#id_scanQR").show(),e("#previewQR").hide()}.bind(this),this.editFormReport.bind(this)),e("#previewQR").show(),e("#previewQRdiv").show(),e("#id_stopQR").show(),e("#id_scanQR").hide(),!1},editFormReport:function(t){if("string"==typeof t)e("#QRvalue").text(t),e("#id_stopQR").hide(),e("#id_scanQR").show(),e("#previewQRdiv").hide(),e("#idbuttonnextcam").hide();else if("object"==typeof t)if(0==t.code)n.get_string("warnqrscannererror","treasurehunt"),e("#outQRCode").text("Camera access error!");else{let n=t.camera;e("#QRvalue").text(n+":"+t.cameras[n].name);let i=(n+1)%t.cameras.length;i!=n?(e("#idbuttonnextcam").text(i+":"+t.cameras[i].name),e("#idbuttonnextcam").show()):e("#idbuttonnextcam").hide()}},unloadQR:function(t){if(void 0===o)return;o.stop().then((function(){console.info("camera stopped")})),i=-1,e("#previewQRvideo").hide(),"function"==typeof t&&t("")},loadQR:function(t,n){let r=e("#previewQRvideo");r.show(),(o=new Instascan.Scanner({video:r.get(0),mirror:!1})).addListener("scan",t),Instascan.Camera.getCameras().then((function(e){(a=e).length>0?(i=0,o.start(a[i]).then((function(){n({camera:i,cameras:a})})).catch((function(e){n(e)}))):console.error("No cameras found.")})).catch((function(e){n(e)}))},getnextwebCam:function(){return null===a||-1===i?0:(i+1)%a.length},getbackCam:function(){var e=this.getnextwebCam();if(null!==a&&a.length>1)for(var t=0;t<a.length;t++)null!==a[t].name&&-1!=a[t].name.toLowerCase().indexOf("back")&&(e=t);return e},setnextwebcam:function(e){let t=this.getnextwebCam();if(i!=t)if(null!==a)try{selectCamera(a,t,e)}catch(t){console.error(t),e(t.message)}else Instascan.Camera.getCameras().then((function(n){this.selectCamera(n,t,e)})).catch((function(t){console.error(t),e(t.message)}))},selectCamera:selectCamera}}));