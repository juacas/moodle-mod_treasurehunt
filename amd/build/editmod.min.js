define("mod_treasurehunt/editmod",["exports","jquery","mod_treasurehunt/ol","core/ajax","core/notification","mod_treasurehunt/osm-geocoder","mod_treasurehunt/viewgpx","core/str"],(function(_exports,_jquery,_ol,_ajax,_notification,_osmGeocoder,_viewgpx,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * @module mod_treasurehunt/edit
   * @package
   * @copyright 2016 onwards Adrian Rodriguez Fernandez <huorwhisp@gmail.com>,
   *            Juan Pablo de Castro <jpdecastro@tel.uva.es>
   * @author Adrian Rodriguez <huorwhisp@gmail.com>
   * @author Juan Pablo de Castro <jpdecastro@tel.uva.es>*
   * @license http:// www.gnu.org/copyleft/gpl.html GNU GPL v3 or later.
   */function initedittreasurehunt(idModule,treasurehuntid,strings,selectedroadid,lockid,custommapconfig){var mapprojobj=new _ol.default.proj.Projection("EPSG:3857"),custombaselayer=null,geographictools=!0;if(null!=custommapconfig){if(null!==custommapconfig.custombackgroundurl){var customimageextent=function(custommapconfig,mapprojection,referencetocenter){var customimageextent=_ol.default.proj.transformExtent(custommapconfig.bbox,"EPSG:4326",mapprojection);if(1==custommapconfig.preserveaspectratio){var bboxheight=customimageextent[3]-customimageextent[1],centerwidth=(customimageextent[2]+customimageextent[0])/2,centerheight=(customimageextent[3]+customimageextent[1])/2,ratiorealmap=Math.round(bboxheight/custommapconfig.imgheight),adjwidth=Math.round(custommapconfig.imgwidth*ratiorealmap),adjheight=Math.round(custommapconfig.imgheight*ratiorealmap);customimageextent=referencetocenter?[centerwidth-adjwidth/2,centerheight-adjheight/2,centerwidth+adjwidth/2,centerheight+adjheight/2]:[customimageextent[0],customimageextent[1],customimageextent[0]+adjwidth,customimageextent[1]+adjheight]}return customimageextent}(custommapconfig,"EPSG:3857",!1);custombaselayer=new _ol.default.layer.Image({title:custommapconfig.layername,type:custommapconfig.layertype,source:new _ol.default.source.ImageStatic({url:custommapconfig.custombackgroundurl,imageExtent:customimageextent}),opacity:1})}else if(null!==custommapconfig.wmsurl){let options={type:custommapconfig.layertype,title:custommapconfig.layername,name:custommapconfig.layername};if("wms"===custommapconfig.layerservicetype?options.source=new _ol.default.source.TileWMS({url:custommapconfig.wmsurl,params:custommapconfig.wmsparams}):"tiled"===custommapconfig.layerservicetype?options.source=new _ol.default.source.XYZ({url:custommapconfig.wmsurl}):"arcgis"===custommapconfig.layerservicetype&&(options.source=new _ol.default.source.TileArcGISRest({url:custommapconfig.wmsurl})),custommapconfig.bbox[0]&&custommapconfig.bbox[1]&&custommapconfig.bbox[2]&&custommapconfig.bbox[3]){let customwmsextent=_ol.default.proj.transformExtent(custommapconfig.bbox,"EPSG:4326","EPSG:3857");options.extent=customwmsextent}(custombaselayer=new _ol.default.layer.Tile(options)).set("name",custommapconfig.layername)}geographictools=custommapconfig.geographic}var stageposition,roadid,stageid,selectedFeatures,treasurehunt={roads:{}},dirtyStages=new _ol.default.source.Vector({projection:"EPSG:3857"}),originalStages=new _ol.default.source.Vector({projection:"EPSG:3857"}),dirty=!1,abortDrawing=!1,drawStarted=!1,selectedstageFeatures={},idNewFeature=1,vectorSelected=new _ol.default.layer.Vector({source:new _ol.default.source.Vector({projection:"EPSG:3857"})});let osmGeocoderXHR;function relocatestageList($listitems,$listlength,i,dirtyStages,originalStages,vector){var newVal,$item=(0,_jquery.default)($listitems).get([i]),roadid=(0,_jquery.default)($item).attr("roadid");newVal=Math.abs((0,_jquery.default)($item).index('li[roadid="'+roadid+'"]')-$listlength),(0,_jquery.default)($item).attr("stageposition",newVal),(0,_jquery.default)($item).find(".sortable-number").text(newVal),(0,_jquery.default)($item).hasClass("ui-selected")&&(stageposition=newVal),function(stageid,stageposition,roadid,dirtySource,originalStages,vector){var idFeaturesPolygons,feature=dirtySource.getFeatureById(stageid);feature||((feature=originalStages.getFeatureById(stageid).clone()).setId(stageid),dirtySource.addFeature(feature));if(feature.setProperties({stageposition:stageposition}),"empty"!==feature.get("idFeaturesPolygons"))for(var i=0,j=(idFeaturesPolygons=feature.get("idFeaturesPolygons").split(",")).length;i<j;i++)vector.getSource().getFeatureById(idFeaturesPolygons[i]).setProperties({stageposition:stageposition})}(parseInt((0,_jquery.default)($item).attr("stageid"),10),newVal,parseInt((0,_jquery.default)($item).attr("roadid"),10),dirtyStages,originalStages,vector)}geographictools&&((0,_jquery.default)('<div id="searchcontainer">').appendTo((0,_jquery.default)("#controlpanel")),(0,_jquery.default)('<input type="search" placeholder="'+strings.searchlocation+'" class="searchaddress"/>').appendTo((0,_jquery.default)("#searchcontainer")),(0,_jquery.default)('<span class="ui-icon  ui-icon-search searchicon"></span>').prependTo((0,_jquery.default)("#searchcontainer")),(0,_jquery.default)('<span class="ui-icon  ui-icon-closethick closeicon invisible"></span>').appendTo((0,_jquery.default)("#searchcontainer"))),(0,_jquery.default)('<ul id="stagelist"/>').prependTo((0,_jquery.default)("#stagelistpanel")),(0,_jquery.default)("#stagelist").sortable({handle:".handle",tolerance:"pointer",zIndex:9999,opacity:.5,forcePlaceholderSize:!0,cursorAt:{top:-7},cursor:"n-resize",axis:"y",items:"li:not(:hidden , .blocked)",helper:"clone",start:function(event,ui){var roadid=ui.item.attr("roadid"),start_pos=ui.item.index('li[roadid="'+roadid+'"]'),scrollParent=(0,_jquery.default)(this).data("ui-sortable").scrollParent,maxScrollTop=scrollParent[0].scrollHeight-scrollParent[0].clientHeight-ui.helper.height();ui.item.data("start_pos",start_pos),(0,_jquery.default)(this).data("maxScrollTop",maxScrollTop)},sort:function(){var scrollParent=(0,_jquery.default)(this).data("ui-sortable").scrollParent,maxScrollTop=(0,_jquery.default)(this).data("maxScrollTop");scrollParent.scrollTop()>maxScrollTop&&scrollParent.scrollTop(maxScrollTop)},update:function(event,ui){var i,start_pos=ui.item.data("start_pos"),roadid=ui.item.attr("roadid"),end_pos=ui.item.index('li[roadid="'+roadid+'"]'),$listitems=(0,_jquery.default)(this).children('li[roadid="'+roadid+'"]'),$listlength=(0,_jquery.default)($listitems).length;if(start_pos!==end_pos){if(start_pos<end_pos)for(i=start_pos;i<=end_pos;i++)relocatestageList($listitems,$listlength,i,dirtyStages,originalStages,treasurehunt.roads[roadid].vector);else for(i=end_pos;i<=start_pos;i++)relocatestageList($listitems,$listlength,i,dirtyStages,originalStages,treasurehunt.roads[roadid].vector);activateSaveButton(),dirty=!0}}}).disableSelection(),(0,_jquery.default)('<ul id="roadlist"/>').appendTo((0,_jquery.default)("#roadlistpanel")),window.app={};var app=window.app;app.generateResizableControl=function(opt_options){var options=opt_options||{},button=document.createElement("button"),element=document.createElement("div");button.innerHTML="<>",button.id="egrip",element.className="ol-control ol-unselectable egrip-container",element.appendChild(button),_ol.default.control.Control.call(this,{element:element,target:options.target})},_ol.default.inherits(app.generateResizableControl,_ol.default.control.Control);var defaultstageStyle=new _ol.default.style.Style({fill:new _ol.default.style.Fill({color:"rgba(100, 100, 255, 0.2)"}),stroke:new _ol.default.style.Stroke({color:"rgba(100, 100, 255, 0.5)",width:2}),image:new _ol.default.style.Circle({radius:5,fill:new _ol.default.style.Fill({color:"#ffcc33"}),stroke:new _ol.default.style.Stroke({color:"#000000",width:2})}),text:new _ol.default.style.Text({textAlign:"center",scale:1.3,fill:new _ol.default.style.Fill({color:"#fff"}),stroke:new _ol.default.style.Stroke({color:"#6C0492",width:3.5})})}),selectedstageStyle=new _ol.default.style.Style({fill:new _ol.default.style.Fill({color:"rgba(200, 100, 100, 0.2)"}),stroke:new _ol.default.style.Stroke({color:"rgba(255, 0, 0, 0.5)",width:3}),image:new _ol.default.style.Circle({radius:5,fill:new _ol.default.style.Fill({color:"#ffcc33"}),stroke:new _ol.default.style.Stroke({color:"#000000",width:2})}),text:new _ol.default.style.Text({textAlign:"center",scale:1.3,fill:new _ol.default.style.Fill({color:"#fff"}),stroke:new _ol.default.style.Stroke({color:"#C3000B",width:3.5})}),zIndex:"Infinity"}),vectorDraw=new _ol.default.layer.Vector({source:new _ol.default.source.Vector({projection:"EPSG:3857"}),visible:!1});let aeriallayer=new _ol.default.layer.Tile({type:"base",visible:!1,title:strings.aerialmap,source:new _ol.default.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",attributions:["Tiles © Esri — Fuente: Esri, DigitalGlobe, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community"]})}),roadlayer=new _ol.default.layer.Tile({title:strings.roadmap,type:"base",visible:!0,source:new _ol.default.source.OSM});var basemaps=new _ol.default.layer.Group({title:strings.basemaps,layers:[aeriallayer,roadlayer]});null!==custombaselayer&&(custommapconfig.onlybase&&basemaps.getLayers().clear(),basemaps.getLayers().push(custombaselayer));var overlay=_viewgpx.default.createCoordsOverlay("#mapedit",null,strings.pegmanlabel),layerSwitcher=new _ol.default.control.LayerSwitcher,map=new _ol.default.Map({layers:[basemaps,vectorDraw],overlays:[overlay],projection:mapprojobj,renderer:"canvas",target:"mapedit",view:new _ol.default.View({center:[0,0],zoom:2,minZoom:2}),controls:_ol.default.control.defaults().extend([layerSwitcher,new app.generateResizableControl({target:document.getElementById("stagelistpanel")})])});map.on("click",(function(evt){Draw.getActive()||Modify.getActive()||null!==custommapconfig&&!custommapconfig.geographic||overlay.setPosition(evt.coordinate)})),layerSwitcher.showPanel(),(0,_jquery.default)("#stagelistpanel").resizable({handles:{e:(0,_jquery.default)("#egrip")},resize:function(event,ui){ui.size.height=ui.originalSize.height},stop:function(){map.updateSize()},cancel:""});var Modify={init:function(){this.select=new _ol.default.interaction.Select({filter:function(feature){return!!selectedstageFeatures[feature.getId()]},style:function(feature){var fill=new _ol.default.style.Fill({color:"rgba(255,100,100,0.4)"}),stroke=new _ol.default.style.Stroke({color:"rgba(255, 0, 0, 1)",width:4});return[new _ol.default.style.Style({image:new _ol.default.style.Circle({fill:fill,stroke:stroke,radius:5}),fill:fill,stroke:stroke,text:new _ol.default.style.Text({text:""+feature.get("stageposition"),textAlign:"center",scale:1.3,fill:new _ol.default.style.Fill({color:"#fff"}),stroke:new _ol.default.style.Stroke({color:"rgba(255, 0, 0, 1)",width:3.5})}),zIndex:"Infinity"})]}}),map.addInteraction(this.select),this.modify=new _ol.default.interaction.Modify({features:this.select.getFeatures(),style:new _ol.default.style.Style({image:new _ol.default.style.Circle({radius:5,fill:new _ol.default.style.Fill({color:"#3399CC"}),stroke:new _ol.default.style.Stroke({color:"#000000",width:2})})}),deleteCondition:function(event){return _ol.default.events.condition.shiftKeyOnly(event)&&_ol.default.events.condition.singleClick(event)}}),map.addInteraction(this.modify),this.setEvents()},setEvents:function(){selectedFeatures=this.select.getFeatures(),this.select.on("change:active",(function(){selectedFeatures.clear(),deactivateDeleteButton()})),this.select.on("select",(function(){selectedFeatures.getLength()>0?(0,_jquery.default)("#removefeature").prop("disabled",!1):deactivateDeleteButton()})),this.modify.on("modifyend",(function(e){activateSaveButton(),function(dirtyFeatures,originalStages,dirtySource,vector){dirtyFeatures.forEach((function(dirtyFeature){var idFeaturesPolygons,stageid=dirtyFeature.get("stageid"),feature=dirtySource.getFeatureById(stageid);feature||((feature=originalStages.getFeatureById(stageid).clone()).setId(stageid),dirtySource.addFeature(feature));for(var multipolygon=new _ol.default.geom.MultiPolygon([]),i=0,j=(idFeaturesPolygons=feature.get("idFeaturesPolygons").split(",")).length;i<j;i++)multipolygon.appendPolygon(vector.getSource().getFeatureById(idFeaturesPolygons[i]).getGeometry().clone());feature.setGeometry(multipolygon)}))}(e.features,originalStages,dirtyStages,treasurehunt.roads[roadid].vector),dirty=!0}))},getActive:function(){return!(!this.select.getActive()||!this.modify.getActive())},setActive:function(active){this.select.setActive(active),this.modify.setActive(active)}};Modify.init();var Draw={init:function(){map.addInteraction(this.Polygon),this.Polygon.setActive(!1),this.setEvents()},Polygon:new _ol.default.interaction.Draw({source:vectorDraw.getSource(),type:"Polygon",style:new _ol.default.style.Style({fill:new _ol.default.style.Fill({color:"rgba(0, 0, 0, 0.05)"}),stroke:new _ol.default.style.Stroke({color:"#FAC30B",width:2}),image:new _ol.default.style.Circle({radius:5,fill:new _ol.default.style.Fill({color:"#ffcc33"}),stroke:new _ol.default.style.Stroke({color:"#000000",width:2})}),zIndex:"Infinity"})}),setEvents:function(){this.Polygon.on("drawend",(function(e){drawStarted=!1,abortDrawing?(vectorDraw.getSource().clear(),abortDrawing=!1):(e.feature.setProperties({roadid:roadid,stageid:stageid,stageposition:stageposition}),selectedstageFeatures[idNewFeature]=!0,e.feature.setId(idNewFeature),idNewFeature++,treasurehunt.roads[roadid].vector.getSource().addFeature(e.feature),function(dirtyFeature,originalStages,dirtySource){var stageid=dirtyFeature.get("stageid"),roadid=dirtyFeature.get("roadid"),feature=dirtySource.getFeatureById(stageid);feature||((feature=originalStages.getFeatureById(stageid).clone()).setId(stageid),dirtySource.addFeature(feature));"empty"===feature.get("idFeaturesPolygons")?(feature.setProperties({idFeaturesPolygons:""+dirtyFeature.getId()}),function(stageid,roadid){if((0,_jquery.default)('#stagelist li[stageid="'+stageid+'"]').children(".handle, .nohandle").addClass("validstage").removeClass("invalidstage"),roadid){(0,_jquery.default)("label[for='addradio']").removeClass("highlightbutton"),0===(0,_jquery.default)("#stagelist li[roadid='"+roadid+"']").find(".invalidstage").length&&(0,_jquery.default)("#erremptystage").addClass("invisible")}}(stageid,roadid)):feature.setProperties({idFeaturesPolygons:feature.get("idFeaturesPolygons")+","+dirtyFeature.getId()});feature.getGeometry().appendPolygon(dirtyFeature.getGeometry())}(e.feature,originalStages,dirtyStages),vectorDraw.getSource().clear(),activateSaveButton(),dirty=!0)})),this.Polygon.on("drawstart",(function(){drawStarted=!0}))},getActive:function(){return this.Polygon.getActive()},setActive:function(active){active?this.Polygon.setActive(!0):this.Polygon.setActive(!1),map.getTargetElement().style.cursor=active?"none":""}};(0,_jquery.default)(document).keyup((function(e){27===e.keyCode&&drawStarted&&(abortDrawing=!0,Draw.Polygon.finishDrawing())})),Draw.init(),activateNavigationMode(),deactivateEdition();var snap=new _ol.default.interaction.Snap({source:vectorDraw.getSource()});function styleFunction(feature){var stageposition=feature.get("stageposition");return isNaN(stageposition)||(selectedstageStyle.getText().setText(""+stageposition),defaultstageStyle.getText().setText(""+stageposition)),selectedstageFeatures[feature.getId()]?[selectedstageStyle]:[defaultstageStyle]}function selectfirstroad(roads,map){var noroads=0;for(var road in roads)if(treasurehunt.roads.hasOwnProperty(road)){noroads=1,roads[roadid=road].blocked?deactivateAddstage():activateAddstage(),selectRoad(roadid,roads[roadid].vector,map);break}0===noroads&&(deactivateAddstage(),(0,_jquery.default)("#addroad").addClass("highlightbutton").blur(),(0,_jquery.default)("#stagelistpanel").addClass("invisible"),map.updateSize())}function emptystage(stageid,roadid){((0,_jquery.default)('#stagelist li[stageid="'+stageid+'"]').children(".handle,.nohandle").addClass("invalidstage").removeClass("validstage"),roadid)&&((0,_jquery.default)("label[for='addradio']").addClass("highlightbutton"),(0,_jquery.default)("#stagelist li[roadid='"+roadid+"']").length>=2&&(0,_jquery.default)("#erremptystage").removeClass("invisible"))}function deactivateDeleteButton(){(0,_jquery.default)("#removefeature").prop("disabled",!0)}function activateAddstage(){(0,_jquery.default)("#addstage").prop("disabled",!1)}function deactivateAddstage(){(0,_jquery.default)("#addstage").prop("disabled",!0)}function deactivateEdition(){(0,_jquery.default)("#editmode").prop("disabled",!0),(0,_jquery.default)("#drawmode").prop("disabled",!0),activateNavigationMode()}function activateNavigationMode(){(0,_jquery.default)("#editmode").removeClass("selectedbutton").prop("z-index","Infinity"),(0,_jquery.default)("#drawmode").removeClass("selectedbutton").prop("z-index","Infinity"),(0,_jquery.default)("#navmode").prop("disabled",!1).addClass("selectedbutton").blur().prop("z-index",999),Draw.setActive(!1),Modify.setActive(!1)}function activateModify(){(0,_jquery.default)("#editmode").addClass("selectedbutton").blur().prop("z-index",999),(0,_jquery.default)("#drawmode").removeClass("selectedbutton").prop("z-index","Infinity"),(0,_jquery.default)("#navmode").removeClass("selectedbutton").prop("z-index","Infinity"),Draw.setActive(!1),Modify.setActive(!0)}function activateSaveButton(){(0,_jquery.default)("#savestage").prop("disabled",!1)}function flyTo(map,point,extent){var view=map.getView();extent?view.fit(extent,{duration:700}):view.animate({zoom:19,center:point,duration:700})}function check_stage_list($stagelist){$stagelist.length>0?((0,_jquery.default)("#stagelistpanel").removeClass("invisible"),map.updateSize()):((0,_jquery.default)("#stagelistpanel").addClass("invisible"),map.updateSize()),$stagelist.length<2?((0,_jquery.default)("#addstage").addClass("highlightbutton").blur(),(0,_jquery.default)("#errvalidroad").removeClass("invisible"),(0,_jquery.default)("#erremptystage").addClass("invisible")):$stagelist.find(".invalidstage").length>0?((0,_jquery.default)("#addstage").removeClass("highlightbutton"),(0,_jquery.default)("#errvalidroad").addClass("invisible"),(0,_jquery.default)("#erremptystage").removeClass("invisible")):((0,_jquery.default)("#addstage").removeClass("highlightbutton"),(0,_jquery.default)("#errvalidroad").addClass("invisible"),(0,_jquery.default)("#erremptystage").addClass("invisible"))}function selectRoad(roadid,vectorOfPolygons,map){(0,_jquery.default)("#stagelist li").removeClass("ui-selected").hide();var $stagelist=(0,_jquery.default)("#stagelist li[roadid='"+roadid+"']");$stagelist.show(),check_stage_list($stagelist),(0,_jquery.default)("#roadlist li[roadid='"+roadid+"']").addClass("ui-selected"),map.getLayers().forEach((function(layer){layer instanceof _ol.default.layer.Vector&&layer.setVisible(!1)})),vectorOfPolygons.setVisible(!0),vectorOfPolygons.getSource().getFeatures().length>0&&flyTo(map,null,vectorOfPolygons.getSource().getExtent())}function editFormstageEntry(stageid,idModule){var url="editstage.php?cmid="+idModule+"&id="+stageid;window.location.href=url}function newFormstageEntry(roadid,idModule){var url="editstage.php?cmid="+idModule+"&roadid="+roadid;window.location.href=url}function editFormRoadEntry(roadid,idModule){var url="editroad.php?cmid="+idModule+"&id="+roadid;window.location.href=url}function newFormRoadEntry(idModule){var url="editroad.php?cmid="+idModule;window.location.href=url}function deleteRoad(roadid,dirtySource,originalStages,treasurehuntid,lockid){(0,_jquery.default)(".treasurehunt-editor-loader").show(),_ajax.default.call([{methodname:"mod_treasurehunt_delete_road",args:{roadid:roadid,treasurehuntid:treasurehuntid,lockid:lockid}}])[0].done((function(response){if((0,_jquery.default)(".treasurehunt-editor-loader").hide(),response.status.code)_notification.default.alert("Error",response.status.msg,"Continue");else{!function(roadid){var $li=(0,_jquery.default)('#roadlist li[roadid="'+roadid+'"]');if($li.length>0){var $lis=(0,_jquery.default)('#stagelist li[roadid="'+roadid+'"]');$li.remove(),$lis.remove()}}(roadid),map.removeLayer(treasurehunt.roads[roadid].vector),delete treasurehunt.roads[roadid],selectfirstroad(treasurehunt.roads,map),deactivateEdition();for(var features=originalStages.getFeatures(),i=0;i<features.length;i++)if(roadid===features[i].get("roadid")){var dirtyFeature=dirtySource.getFeatureById(features[i].getId());dirtyFeature&&dirtySource.removeFeature(dirtyFeature),originalStages.removeFeature(features[i])}}})).fail((function(error){(0,_jquery.default)(".treasurehunt-editor-loader").hide(),_notification.default.exception(error)}))}function deletestage(stageid,dirtySource,originalStages,vectorOfPolygons,treasurehuntid,lockid){(0,_jquery.default)(".treasurehunt-editor-loader").show(),_ajax.default.call([{methodname:"mod_treasurehunt_delete_stage",args:{stageid:stageid,treasurehuntid:treasurehuntid,lockid:lockid}}])[0].done((function(response){if((0,_jquery.default)(".treasurehunt-editor-loader").hide(),response.status.code)_notification.default.alert("Error",response.status.msg,"Continue");else{var polygonFeature,idFeaturesPolygons=!1,feature=dirtySource.getFeatureById(stageid);if(function(stageid,dirtySource,originalStages,vectorOfPolygons){var $li=(0,_jquery.default)('#stagelist li[stageid="'+stageid+'"]');if($li.length>0){var roadid=$li.attr("roadid"),start_pos=$li.index('li[roadid="'+roadid+'"]');$li.remove();var $stagelist=(0,_jquery.default)("#stagelist li[roadid='"+roadid+"']");check_stage_list($stagelist);for(var $listlength=$stagelist.length,i=0;i<=start_pos-1;i++)relocatestageList($stagelist,$listlength,i,dirtySource,originalStages,vectorOfPolygons)}}(stageid,dirtySource,originalStages,vectorOfPolygons),feature?("empty"!==feature.get("idFeaturesPolygons")&&(idFeaturesPolygons=feature.get("idFeaturesPolygons").split(",")),dirtySource.removeFeature(feature)):("empty"!==(feature=originalStages.getFeatureById(stageid)).get("idFeaturesPolygons")&&(idFeaturesPolygons=feature.get("idFeaturesPolygons").split(",")),originalStages.removeFeature(feature)),idFeaturesPolygons)for(var i=0,j=idFeaturesPolygons.length;i<j;i++)polygonFeature=vectorOfPolygons.getSource().getFeatureById(idFeaturesPolygons[i]),vectorOfPolygons.getSource().removeFeature(polygonFeature)}})).fail((function(error){(0,_jquery.default)(".treasurehunt-editor-loader").hide(),_notification.default.exception(error)}))}function savestages(dirtySource,originalStages,treasurehuntid,callback,options,lockid){(0,_jquery.default)(".treasurehunt-editor-loader").show();var auxfeature,geojsonformat=new _ol.default.format.GeoJSON,dirtyfeatures=dirtySource.getFeatures(),features=[];dirtyfeatures.forEach((function(dirtyfeature){(auxfeature=dirtyfeature.clone()).unset("idFeaturesPolygons"),auxfeature.unset("name"),auxfeature.unset("clue"),auxfeature.unset("treasurehuntid"),auxfeature.setId(dirtyfeature.getId()),features.push(auxfeature)}));var geojsonstages=geojsonformat.writeFeaturesObject(features,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"});_ajax.default.call([{methodname:"mod_treasurehunt_update_stages",args:{stages:geojsonstages,treasurehuntid:treasurehuntid,lockid:lockid}}])[0].done((function(response){var originalFeature;((0,_jquery.default)(".treasurehunt-editor-loader").hide(),response.status.code)?_notification.default.alert("Error",response.status.msg,"Continue"):(dirtySource.forEachFeature((function(feature){(originalFeature=originalStages.getFeatureById(feature.getId())).setProperties(feature.getProperties()),originalFeature.setGeometry(feature.getGeometry())})),dirtySource.clear(),(0,_jquery.default)("#savestage").prop("disabled",!0),dirty=!1,"function"==typeof callback&&options instanceof Array&&callback.apply(null,options))})).fail((function(error){(0,_jquery.default)(".treasurehunt-editor-loader").hide(),_notification.default.alert("Error",error.message,"Continue")}))}map.addInteraction(snap),function(treasurehuntid){_ajax.default.call([{methodname:"mod_treasurehunt_fetch_treasurehunt",args:{treasurehuntid:treasurehuntid}}])[0].done((function(response){if((0,_jquery.default)(".treasurehunt-editor-loader").hide(),response.status.code)_notification.default.alert("Error",response.status.msg,"Continue");else{var vector,features,geoJSON=new _ol.default.format.GeoJSON,roads=response.treasurehunt.roads;Array.isArray(roads)||(roads=Object.values(roads)),roads.forEach((function(road){road.blocked=1==road.blocked,function(roadid,name,blocked){if((0,_jquery.default)('#roadlist li[roadid="'+roadid+'"]').length<1){(0,_jquery.default)('<li roadid="'+roadid+'" blocked="'+blocked+'"/>').appendTo((0,_jquery.default)("#roadlist")).addClass("ui-corner-all").append("<div class='roadname'>"+name+"</div>").append("<div class='modifyroad'><span class='ui-icon ui-icon-trash'></span><span class='ui-icon ui-icon-pencil'></span></div>")}}(road.id,road.name,road.blocked),features=geoJSON.readFeatures(road.stages,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}),originalStages.addFeatures(features),delete road.stages,vector=new _ol.default.layer.Vector({source:new _ol.default.source.Vector({projection:"EPSG:3857"}),updateWhileAnimating:!0,style:styleFunction}),features.forEach((function(feature){null===feature.getGeometry()&&feature.setGeometry(new _ol.default.geom.MultiPolygon([]));for(var polygons=feature.getGeometry().getPolygons(),idNewFeatures="empty",stageposition=feature.get("stageposition"),name=feature.get("name"),clue=feature.get("clue"),stageid=feature.getId(),blocked=road.blocked,i=0;i<polygons.length;i++){var newFeature=new _ol.default.Feature(feature.getProperties());newFeature.setProperties({stageid:stageid});var polygon=polygons[i];newFeature.setGeometry(polygon),newFeature.setId(idNewFeature),idNewFeatures=0===i?idNewFeature:idNewFeatures+","+idNewFeature,idNewFeature++,vector.getSource().addFeature(newFeature)}feature.setProperties({idFeaturesPolygons:""+idNewFeatures}),function(stageid,roadid,stageposition,name,clue,blocked){if((0,_jquery.default)('#stagelist li[stageid="'+stageid+'"]').length<1){var li=(0,_jquery.default)('<li stageid="'+stageid+'" roadid="'+roadid+'" stageposition="'+stageposition+'"/>').appendTo((0,_jquery.default)("#stagelist"));li.addClass("ui-corner-all").append("<div class='stagename'>"+name+"</div>").append("<div class='modifystage'><span class='ui-icon ui-icon-pencil'></span><span class='ui-icon ui-icon-info' data-id='#dialoginfo"+stageid+"'><div id='dialoginfo"+stageid+"' title='"+(0,_jquery.default)(_jquery.default.parseHTML(name)).text()+"'>"+clue+"</div></span></div>"),blocked?li.addClass("blocked").prepend("<div class='nohandle validstage'><span class='ui-icon ui-icon-locked'></span><span class='sortable-number'>"+stageposition+"</span></div>"):(li.prepend("<div class='handle validstage'><span class='ui-icon ui-icon-arrowthick-2-n-s'></span><span class='sortable-number'>"+stageposition+"</span></div>"),li.children(".modifystage").prepend("<span class='ui-icon ui-icon-trash'></span>")),(0,_jquery.default)("#dialoginfo"+stageid).dialog({maxHeight:500,autoOpen:!1})}}(stageid,road.id,stageposition,name,clue,blocked),0===polygons.length&&emptystage(stageid)})),road.vector=vector,map.addLayer(vector),treasurehunt.roads[road.id]=road})),(0,_jquery.default)("#stagelist li").sort((function(a,b){var contentA=parseInt((0,_jquery.default)(a).attr("stageposition")),contentB=parseInt((0,_jquery.default)(b).attr("stageposition"));return contentA<contentB?1:contentA>contentB?-1:0})).appendTo((0,_jquery.default)("#stagelist")),void 0!==treasurehunt.roads[selectedroadid]?(roadid=selectedroadid,treasurehunt.roads[roadid].blocked?deactivateAddstage():activateAddstage(),selectRoad(roadid,treasurehunt.roads[roadid].vector,map)):selectfirstroad(treasurehunt.roads,map)}})).fail((function(error){(0,_jquery.default)(".treasurehunt-editor-loader").hide(),_notification.default.exception(error)}))}(treasurehuntid),(0,_jquery.default)(".searchaddress").autocomplete({minLength:4,source:function(request,response){var term=request.term;osmGeocoderXHR&&osmGeocoderXHR.abort(),osmGeocoderXHR=_osmGeocoder.default.search(term).done((data=>{if(0!==data.length){for(var total=[],i=0,l=data.length;i<l;i++){var latitude,longitude;latitude=data[i].lat,longitude=data[i].lon;var result={value:data[i].display_name,latitude:latitude,longitude:longitude,boundingbox:data[i].boundingbox};total[i]=result}response(total)}else response()})).fail((()=>{response()})).always((()=>{osmGeocoderXHR=null}))},select:function(event,ui){if(ui.item.boundingbox){var extend=[];extend[0]=parseFloat(ui.item.boundingbox[2]),extend[1]=parseFloat(ui.item.boundingbox[0]),extend[2]=parseFloat(ui.item.boundingbox[3]),extend[3]=parseFloat(ui.item.boundingbox[1]),extend=_ol.default.proj.transformExtent(extend,"EPSG:4326","EPSG:3857"),flyTo(map,null,extend)}else{var point=_ol.default.proj.fromLonLat([ui.item.longitude,ui.item.latitude]);flyTo(map,point)}},autoFocus:!0}).on("click",(function(){(0,_jquery.default)(this).autocomplete("search",(0,_jquery.default)(this).value)})),_jquery.default.ui.autocomplete.prototype._resizeMenu=function(){this.menu.element.outerWidth(this.element.outerWidth())},(0,_jquery.default)("#drawmode").css("position","relative").on("click",(function(){(0,_jquery.default)("#drawmode").addClass("selectedbutton").blur().prop("z-index","Infinity"),(0,_jquery.default)("#editmode").removeClass("selectedbutton").prop("z-index","auto"),(0,_jquery.default)("#navmode").removeClass("selectedbutton").prop("z-index","auto"),Modify.setActive(!1),Draw.setActive(!0)})),(0,_jquery.default)("#editmode").css("position","relative").on("click",activateModify),(0,_jquery.default)("#navmode").css("position","relative").on("click",activateNavigationMode),(0,_jquery.default)("#addstage").on("click",(function(){dirty?savestages(dirtyStages,originalStages,treasurehuntid,newFormstageEntry,[roadid,idModule],lockid):newFormstageEntry(roadid,idModule)})),(0,_jquery.default)("#addroad").on("click",(function(){dirty?savestages(dirtyStages,originalStages,treasurehuntid,newFormRoadEntry,[idModule],lockid):newFormRoadEntry(idModule)})),(0,_jquery.default)("#removefeature").on("click",(function(){_notification.default.confirm(strings.areyousure,strings.removewarning,strings.confirm,strings.cancel,(function(){!function(dirtyFeatures,originalStages,dirtySource,vector){dirtyFeatures.forEach((function(dirtyFeature){var idFeaturesPolygons,remove,stageid=dirtyFeature.get("stageid"),roadid=dirtyFeature.get("roadid"),feature=dirtySource.getFeatureById(stageid);feature||((feature=originalStages.getFeatureById(stageid).clone()).setId(stageid),dirtySource.addFeature(feature));for(var multipolygon=new _ol.default.geom.MultiPolygon([]),i=0,j=(idFeaturesPolygons=feature.get("idFeaturesPolygons").split(",")).length;i<j;i++)idFeaturesPolygons[i]!=dirtyFeature.getId()?multipolygon.appendPolygon(vector.getSource().getFeatureById(idFeaturesPolygons[i]).getGeometry().clone()):remove=i;feature.setGeometry(multipolygon),multipolygon.getPolygons().length?(idFeaturesPolygons.splice(remove,1),feature.setProperties({idFeaturesPolygons:idFeaturesPolygons.join()})):(feature.setProperties({idFeaturesPolygons:"empty"}),emptystage(stageid,roadid))}))}(selectedFeatures,originalStages,dirtyStages,treasurehunt.roads[roadid].vector),function(selectedFeatures,vector){selectedFeatures.forEach((function(feature){vector.getSource().removeFeature(feature)})),selectedFeatures.clear()}(selectedFeatures,treasurehunt.roads[roadid].vector),deactivateDeleteButton(),activateSaveButton(),dirty=!0}))})),(0,_jquery.default)("#savestage").on("click",(function(){savestages(dirtyStages,originalStages,treasurehuntid,null,null,lockid)})),(0,_jquery.default)("#stagelist").on("click",".ui-icon-info, .ui-icon-alert",(function(){var id=(0,_jquery.default)(this).data("id");(0,_jquery.default)(id).dialog("open"),(0,_jquery.default)(".ui-dialog :button").blur()})),(0,_jquery.default)("#stagelist").on("click",".ui-icon-trash",(function(){var $this_li=(0,_jquery.default)(this).parents("li");_notification.default.confirm(strings.areyousure,strings.removewarning,strings.confirm,strings.cancel,(function(){deletestage(parseInt($this_li.attr("stageid")),dirtyStages,originalStages,treasurehunt.roads[roadid].vector,treasurehuntid,lockid)}))})),(0,_jquery.default)("#stagelist").on("click",".ui-icon-pencil",(function(){var stageid=parseInt((0,_jquery.default)(this).parents("li").attr("stageid"));dirty?savestages(dirtyStages,originalStages,treasurehuntid,editFormstageEntry,[stageid,idModule],lockid):editFormstageEntry(stageid,idModule)})),(0,_jquery.default)("#stagelist").on("click","li",(function(e){(0,_jquery.default)(e.target).is(".handle ,.nohandle, .ui-icon , .sortable-number")?e.preventDefault():((0,_jquery.default)(this).addClass("ui-selected").siblings().removeClass("ui-selected"),stageposition=parseInt((0,_jquery.default)(this).attr("stageposition")),stageid=parseInt((0,_jquery.default)(this).attr("stageid")),function(vectorOfPolygons,vectorSelected,selected,selectedFeatures,dirtySource,originalStages){vectorSelected.getSource().clear(),selectedFeatures.clear(),selectedstageFeatures={};var feature=dirtySource.getFeatureById(selected);if(feature||(feature=originalStages.getFeatureById(selected)))if("empty"!==feature.get("idFeaturesPolygons")){for(var idFeaturesPolygons=feature.get("idFeaturesPolygons").split(","),i=0,j=idFeaturesPolygons.length;i<j;i++)vectorSelected.getSource().addFeature(vectorOfPolygons.getSource().getFeatureById(idFeaturesPolygons[i]).clone()),selectedstageFeatures[idFeaturesPolygons[i]]=!0;vectorSelected.getSource().getFeatures().length&&flyTo(map,null,vectorSelected.getSource().getExtent())}else vectorOfPolygons.changed();else vectorOfPolygons.changed()}(treasurehunt.roads[roadid].vector,vectorSelected,stageid,selectedFeatures,dirtyStages,originalStages),(0,_jquery.default)("#drawmode").prop("disabled",!1),(0,_jquery.default)("#editmode").prop("disabled",!1),activateModify(),(0,_jquery.default)(this).find(".invalidstage").length>0?(0,_jquery.default)("label[for='addradio']").addClass("highlightbutton"):(0,_jquery.default)("label[for='addradio']").removeClass("highlightbutton"),drawStarted&&(abortDrawing=!0,Draw.Polygon.finishDrawing()))})),(0,_jquery.default)("#roadlist").on("click","li",(function(e){if((0,_jquery.default)(e.target).is(".ui-icon"))e.preventDefault();else{(0,_jquery.default)(this).addClass("ui-selected").siblings().removeClass("ui-selected"),selectedstageFeatures={},drawStarted&&(abortDrawing=!0,Draw.Polygon.finishDrawing()),roadid=(0,_jquery.default)(this).attr("roadid");var scrolltop,blocked=(0,_jquery.default)(this).attr("blocked");parseInt(blocked)||"true"===blocked?deactivateAddstage():activateAddstage(),selectRoad(roadid,treasurehunt.roads[roadid].vector,map),deactivateEdition(),scrolltop="fixed"===(0,_jquery.default)("header[role=banner]").css("position")?parseInt((0,_jquery.default)(".treasurehunt-editor").offset().top)-parseInt((0,_jquery.default)("header[role=banner]").outerHeight(!0)):parseInt((0,_jquery.default)(".treasurehunt-editor").offset().top),(0,_jquery.default)("html, body").animate({scrollTop:scrolltop},500)}})),(0,_jquery.default)("#roadlist").on("click",".ui-icon-pencil",(function(){var roadid=parseInt((0,_jquery.default)(this).parents("li").attr("roadid"));dirty?savestages(dirtyStages,originalStages,treasurehuntid,editFormRoadEntry,[roadid,idModule],lockid):editFormRoadEntry(roadid,idModule)})),(0,_jquery.default)("#roadlist").on("click",".ui-icon-trash",(function(){var $this_li=(0,_jquery.default)(this).parents("li");_notification.default.confirm(strings.areyousure,strings.removeroadwarning,strings.confirm,strings.cancel,(function(){deleteRoad(parseInt($this_li.attr("roadid")),dirtyStages,originalStages,treasurehuntid,lockid)}))})),map.on("pointermove",(function(evt){if(!evt.dragging&&!Draw.getActive()&&Modify.getActive()){var pixel=map.getEventPixel(evt.originalEvent),hit=map.forEachFeatureAtPixel(pixel,(function(feature,layer){if(selectedstageFeatures[feature.getId()]){if(null===layer)return!1;var selected=!1;return selectedFeatures.forEach((function(featureSelected){feature===featureSelected&&(selected=!0)})),!selected}return!1}));map.getTargetElement().style.cursor=hit?"pointer":""}})),(0,_jquery.default)(document).on("touchend",".ui-dialog-titlebar-close",(function(){(0,_jquery.default)(this).parent().siblings(".ui-dialog-content").dialog("close")})),(0,_jquery.default)(".searchaddress").on("input",(function(){var v;(0,_jquery.default)(".closeicon")[(v=this.value,v?"removeClass":"addClass")]("invisible")})),(0,_jquery.default)(".closeicon").on("touchstart click",(function(ev){ev.preventDefault(),(0,_jquery.default)(this).addClass("invisible"),(0,_jquery.default)(".searchaddress").val("").change().autocomplete("close")})),window.onbeforeunload=function(e){var message=strings.savewarning;e=e||window.event;if(dirty)return e&&(e.returnValue=message),message}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_ol=_interopRequireDefault(_ol),_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification),_osmGeocoder=_interopRequireDefault(_osmGeocoder),_viewgpx=_interopRequireDefault(_viewgpx);var _default={edittreasurehunt:function(idModule,treasurehuntid,selectedroadid,lockid,custommapconfig){var terms=["stage","road","aerialmap","roadmap","basemaps","add","modify","save","remove","searchlocation","savewarning","removewarning","areyousure","removeroadwarning","confirm","cancel","pegmanlabel","custommapimageerror"],stringsqueried=terms.map((function(term){return"none"==term?null:{key:term,component:"treasurehunt"}}));(0,_str.getStrings)(stringsqueried).then((function(strings){for(var i18n=[],i=0;i<terms.length;i++)i18n[terms[i]]=strings[i];if(null!=custommapconfig&&null!==custommapconfig.custombackgroundurl){var img=new Image;img.onload=function(){custommapconfig.imgwidth=this.naturalWidth,custommapconfig.imgheight=this.naturalHeight,initedittreasurehunt(idModule,treasurehuntid,i18n,selectedroadid,lockid,custommapconfig)},img.onerror=function(){_notification.default.alert("Error",i18n.custommapimageerror,"Continue"),initedittreasurehunt(idModule,treasurehuntid,i18n,selectedroadid,lockid,custommapconfig)},img.src=custommapconfig.custombackgroundurl}else initedittreasurehunt(idModule,treasurehuntid,i18n,selectedroadid,lockid,custommapconfig)}))}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=editmod.min.js.map