define("mod_treasurehunt/play_bootstrap",["exports","jquery","core/url","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/osm-geocoder","mod_treasurehunt/viewgpx","core/str","mod_treasurehunt/webqr","mod_treasurehunt/jquery.truncate","mod_treasurehunt/dropdown"],(function(_exports,_jquery,_url,_ol,_ajax,_osmGeocoder,_viewgpx,_str,_webqr,_jquery2,_dropdown){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * TODO describe module play_bootstrap_new
   *
   * @module     mod_treasurehunt/play_bootstrap_new
   * @copyright  2025 YOUR NAME <your@email.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */
/**
   * @module    mod_treasurehunt/play
   * @package
   * @copyright 2016 onwards Adrian Rodriguez Fernandez <huorwhisp@gmail.com>, Juan Pablo de Castro <jpdecastro@tel.uva.es>
   * @author Adrian Rodriguez <huorwhisp@gmail.com>
   * @author Juan Pablo de Castro <jpdecastro@tel.uva.es>
   * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_url=_interopRequireDefault(_url),_ol=_interopRequireDefault(_ol),_ajax=_interopRequireDefault(_ajax),_osmGeocoder=_interopRequireDefault(_osmGeocoder),_viewgpx=_interopRequireDefault(_viewgpx),_webqr=_interopRequireDefault(_webqr);let init={playtreasurehunt:function(cmid,treasurehuntid,playwithoutmoving,groupmode,lastattempttimestamp,lastroadtimestamp,gameupdatetime,tracking,user,custommapconfig){let customplayerconfig=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null,terms=["stageovercome","failedlocation","stage","stagename","stageclue","question","noanswerselected","timeexceeded","searching","continue","noattempts","aerialview","roadview","noresults","startfromhere","nomarks","updates","activitytoendwarning","huntcompleted","discoveredlocation","answerwarning","error","pegmanlabel","webserviceerror"],stringsqueried=terms.map((term=>({key:term,component:"treasurehunt"})));(0,_str.get_strings)(stringsqueried).then((strings=>{let i18n=[];for(let i=0;i<terms.length;i++)i18n[terms[i]]=strings[i];if(void 0!==custommapconfig&&custommapconfig&&custommapconfig.custombackgroundurl){let img=new Image;img.addEventListener("load",(function(){custommapconfig.imgwidth=this.naturalWidth,custommapconfig.imgheight=this.naturalHeight,initplaytreasurehunt(_jquery.default,i18n,cmid,treasurehuntid,playwithoutmoving,groupmode,lastattempttimestamp,lastroadtimestamp,gameupdatetime,tracking,user,custommapconfig,customplayerconfig)})),img.src=custommapconfig.custombackgroundurl}else initplaytreasurehunt(_jquery.default,i18n,cmid,treasurehuntid,playwithoutmoving,groupmode,lastattempttimestamp,lastroadtimestamp,gameupdatetime,tracking,user,custommapconfig,customplayerconfig)}))}};function calculateCustomImageExtent(custommapconfig,mapprojection){let referencetocenter=arguments.length>2&&void 0!==arguments[2]&&arguments[2];var customimageextent=_ol.default.proj.transformExtent(custommapconfig.bbox,"EPSG:4326",mapprojection);if(1==custommapconfig.preserveaspectratio){var bboxheight=customimageextent[3]-customimageextent[1],centerwidth=(customimageextent[2]+customimageextent[0])/2,centerheight=(customimageextent[3]+customimageextent[1])/2,ratiorealmap=Math.round(bboxheight/custommapconfig.imgheight),adjwidth=Math.round(custommapconfig.imgwidth*ratiorealmap),adjheight=Math.round(custommapconfig.imgheight*ratiorealmap);customimageextent=referencetocenter?[centerwidth-adjwidth/2,centerheight-adjheight/2,centerwidth+adjwidth/2,centerheight+adjheight/2]:[customimageextent[0],customimageextent[1],customimageextent[0]+adjwidth,customimageextent[1]+adjheight]}return customimageextent}function initplaytreasurehunt($,strings,cmid,treasurehuntid,playwithoutmoving,groupmode,lastattempttimestamp,lastroadtimestamp,gameupdatetime,tracking,user,custommapconfig){let playerconfig=arguments.length>12&&void 0!==arguments[12]?arguments[12]:null;setLoading(!0),playwithoutmoving=1==playwithoutmoving,groupmode=1==groupmode,tracking=1==tracking;let customplayerconfig,isfirststage=!1,nextstagefeature=null,mapprojection="EPSG:3857",custombaselayer=null,usegeographictools=!0,defaultzoom=15,supportsTouch="ontouchstart"in window||navigator.msMaxTouchPoints;if(set_player_config(playerconfig),customplayerconfig&&customplayerconfig.defaultzoom&&(defaultzoom=customplayerconfig.defaultzoom),custommapconfig){if(custommapconfig.custombackgroundurl){var customimageextent=calculateCustomImageExtent(custommapconfig,mapprojection,!1);defaultzoom=5,custombaselayer=new _ol.default.layer.Image({title:custommapconfig.layername,name:custommapconfig.layername,type:custommapconfig.layertype,source:new _ol.default.source.ImageStatic({url:custommapconfig.custombackgroundurl,imageExtent:customimageextent}),opacity:1})}else if(custommapconfig.wmsurl){let options={type:custommapconfig.layertype,title:custommapconfig.layername,name:custommapconfig.layername};if("wms"===custommapconfig.layerservicetype?options.source=new _ol.default.source.TileWMS({url:custommapconfig.wmsurl,params:custommapconfig.wmsparams}):"tiled"===custommapconfig.layerservicetype?options.source=new _ol.default.source.XYZ({url:custommapconfig.wmsurl}):"arcgis"===custommapconfig.layerservicetype&&(options.source=new _ol.default.source.TileArcGISRest({url:custommapconfig.wmsurl})),custommapconfig.bbox[0]&&custommapconfig.bbox[1]&&custommapconfig.bbox[2]&&custommapconfig.bbox[3]){let customwmsextent=_ol.default.proj.transformExtent(custommapconfig.bbox,"EPSG:4326",mapprojection);options.extent=customwmsextent}custombaselayer=new _ol.default.layer.Tile(options),custombaselayer.set("name",custommapconfig.layername)}usegeographictools=custommapconfig.geographic}!1===usegeographictools&&(playwithoutmoving=!0,$("#autolocate").hide());let interval,osmGeocoderXHR,successurl=_url.default.imageUrl("success_mark","treasurehunt"),failureurl=_url.default.imageUrl("failure_mark","treasurehunt"),markerurl=_url.default.imageUrl("bootstrap/my_location_3","treasurehunt"),lastsuccessfulstage={},infomsgs=[],attemptshistory=[],changesinattemptshistory=!1,changesinlastsuccessfulstage=!1,changesinquestionstage=!1,fitmap=!1,roadfinished=!1,available=!0,qoaremoved=!1,osmTimer=0,textStyle=new _ol.default.style.Text({textAlign:"center",scale:1.3,fill:new _ol.default.style.Fill({color:"#ffffff"}),stroke:new _ol.default.style.Stroke({color:"#000000",width:3.5})}),selectText=new _ol.default.style.Text({textAlign:"center",scale:1.4,fill:new _ol.default.style.Fill({color:"#fff"}),stroke:new _ol.default.style.Stroke({color:"#0097a7",width:3.5})}),successAttemptStyle=new _ol.default.style.Style({image:new _ol.default.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:successurl}),text:textStyle,zIndex:"Infinity"}),failedAttemptStyle=new _ol.default.style.Style({image:new _ol.default.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:failureurl}),text:textStyle,zIndex:"Infinity"}),defaultSuccessAttemptStyle=new _ol.default.style.Style({image:new _ol.default.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:successurl}),text:selectText,zIndex:"Infinity"}),failSelectAttemptStyle=new _ol.default.style.Style({image:new _ol.default.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:failureurl}),text:selectText,zIndex:"Infinity"}),accuracyFeatureStyle=new _ol.default.style.Style({fill:new _ol.default.style.Fill({color:[255,255,255,.3]}),stroke:new _ol.default.style.Stroke({color:[0,0,0,.5],width:1}),zIndex:-1});function attemptStyle(feature){let stageposition=feature.get("stageposition");return feature.get("geometrysolved")?(successAttemptStyle.getText().setText(""+stageposition),[successAttemptStyle]):(failedAttemptStyle.getText().setText(""+stageposition),[failedAttemptStyle])}function stageStyle(feature){let stageposition=feature.get("stageposition");if(customplayerconfig.shownextareahint||1==stageposition){let text,fill=new _ol.default.style.Fill({color:"rgba(0,0,0,0.1)"}),stroke=new _ol.default.style.Stroke({color:"#0097a7",width:2});return text=1===feature.get("stageposition")?strings.startfromhere:strings.stage+" "+stageposition,[new _ol.default.style.Style({image:new _ol.default.style.Circle({fill:fill,stroke:stroke,radius:5}),fill:fill,stroke:stroke,text:new _ol.default.style.Text({text:text,textAlign:"center",fill:new _ol.default.style.Fill({color:"rgb(255,255,255)"}),stroke:new _ol.default.style.Stroke({color:"#0097a7",width:2}),overflow:!0,scale:2})})]}return[]}function select_style_function(feature){let stageposition=feature.get("stageposition");return feature.get("geometrysolved")?(defaultSuccessAttemptStyle.getText().setText(""+stageposition),[defaultSuccessAttemptStyle]):(failSelectAttemptStyle.getText().setText(""+stageposition),[failSelectAttemptStyle])}function markerFeatureStyle(){let styles=[],positionstyle=new _ol.default.style.Style({fill:new _ol.default.style.Fill({color:"rgba(255, 0, 0, 0.2)"}),image:new _ol.default.style.Icon({src:"./pix/bootstrap/position_marker.png",rotateWithView:!0,scale:.1,anchor:[.5,.5]})}),geom1=markerFeature.getGeometry(),geom2=nextstagefeature?nextstagefeature.getGeometry():null,isinzone=geom2&&geom1&&geom2.intersectsCoordinate(geom1.getFirstCoordinate());if(1==customplayerconfig.showinzonehint&&isinzone&&(positionstyle=new _ol.default.style.Style({fill:new _ol.default.style.Fill({color:"rgba(0, 0, 255, 0.2)"}),image:new _ol.default.style.Icon({src:"./pix/bootstrap/position_marker_in_zone.png",rotateWithView:!0,scale:.1,anchor:[.5,.5]})})),styles.push(positionstyle),1==customplayerconfig.showheadinghint&&!isinzone){let style=headingFeatureStyle(markerFeature);style&&styles.push(style)}if(1==customplayerconfig.showdistancehint&&!isinzone){let style=distanceLabelStyle(markerFeature);style&&styles.push(style)}let pegman=new _ol.default.style.Style({image:new _ol.default.style.Icon({anchor:[.5,.9],opacity:1,scale:1,src:markerurl})});return styles.push(pegman),styles}function distanceLabelStyle(feature){let geomtarget=nextstagefeature?nextstagefeature.getGeometry():null,geomfeature=feature.getGeometry(),originpoint=geomfeature.getFirstCoordinate(),closestpoint=geomtarget&&geomfeature?geomtarget.getClosestPoint(originpoint):null,linestring=geomtarget&&geomfeature?new _ol.default.geom.LineString([originpoint,closestpoint]):null,distance=linestring?_ol.default.Sphere.getLength(linestring):null;if(null===distance)return null;let distanceText="";return distance>1e3?distanceText=(distance/1e3).toFixed(2)+" km":distance>0&&(distanceText=distance.toFixed(0)+" m"),new _ol.default.style.Style({placement:"point",fill:new _ol.default.style.Fill({color:"#000"}),stroke:new _ol.default.style.Stroke({color:"#fff",width:2}),text:new _ol.default.style.Text({padding:[5,5,5,5],offsetY:25,text:distanceText,scale:2,fill:new _ol.default.style.Fill({color:"#000"}),stroke:new _ol.default.style.Stroke({color:"#fff",width:2}),backgroundFill:new _ol.default.style.Fill({color:"rgba(255, 255, 255, 0.7)"}),backgroundStroke:new _ol.default.style.Stroke({color:"#000",width:1})})})}function positionLayerStyle(feature){if(feature){return[new _ol.default.style.Style({fill:new _ol.default.style.Fill({color:"rgba(0, 0, 255, 0.2)"}),image:new _ol.default.style.Icon({src:"./pix/bootstrap/position_marker.png",rotateWithView:!0,scale:.1,anchor:[.5,.5]})})]}return null}function headingFeatureStyle(feature){if(!nextstagefeature)return null;let rotation=calculateHeading(feature.getGeometry(),nextstagefeature.getGeometry())??null;return null===rotation?null:new _ol.default.style.Style({image:new _ol.default.style.Icon({src:"./pix/bootstrap/position_marker_heading_large.png",rotateWithView:!0,rotation:rotation,scale:.1,anchor:[.5,.67]})})}let layers=[],geoJSONFormat=new _ol.default.format.GeoJSON,attemptSource=new _ol.default.source.Vector({projection:"EPSG:3857"}),stageSource=new _ol.default.source.Vector({projection:"EPSG:3857"}),attemptslayer=new _ol.default.layer.Vector({source:attemptSource,style:attemptStyle}),stagelayer=new _ol.default.layer.Vector({source:stageSource,style:stageStyle}),layersbase=[],layersoverlay=[];if(!custommapconfig||!1===custommapconfig.onlybase){let roadlayer=new _ol.default.layer.Tile({source:new _ol.default.source.OSM}),aeriallayer=new _ol.default.layer.Tile({source:new _ol.default.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",attributions:["Tiles © Esri — Fuente: Esri, DigitalGlobe, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community"]})});aeriallayer.set("name",strings.aerialview),roadlayer.set("name",strings.roadview),layersbase=[aeriallayer,roadlayer]}custombaselayer&&("overlay"!=custommapconfig.layertype?layersbase.push(custombaselayer):layersoverlay.push(custombaselayer));let layergroup=new _ol.default.layer.Group({layers:layersbase});var overlay=_viewgpx.default.createCoordsOverlay("#mapplay","css/playerbootstrap/ol-popup.css",strings.pegmanlabel);let toplayer=null;layergroup.getLayers().forEach((layer=>{layer.setVisible(!1),toplayer=layer})),toplayer.setVisible(!0);let view=new _ol.default.View({center:[0,0],zoom:4,minZoom:3,maxZoom:20}),select=new _ol.default.interaction.Select({layers:[attemptslayer],style:select_style_function,filter:feature=>!0!==feature.get("is_stage")}),accuracyFeature=new _ol.default.Feature;accuracyFeature.setProperties({name:"user_accuracy"}),accuracyFeature.setStyle(accuracyFeatureStyle);let positionFeature=new _ol.default.Feature;positionFeature.setProperties({name:"user_position"});let userPositionSource=new _ol.default.source.Vector({features:[accuracyFeature,positionFeature]}),userPositionLayer=new _ol.default.layer.Vector({source:userPositionSource,style:positionLayerStyle}),markerFeature=new _ol.default.Feature;markerFeature.setGeometry(null),markerFeature.setStyle(markerFeatureStyle);let markerSource=new _ol.default.source.Vector({features:[markerFeature]}),markerLayer=new _ol.default.layer.Vector({source:markerSource});layers.push(layergroup),layers=layers.concat(layersoverlay),layers=layers.concat([stagelayer,userPositionLayer,markerLayer,attemptslayer]);let zoom=new _ol.default.control.Zoom({target:"navigation",className:"custom-zoom"}),map=new _ol.default.Map({layers:layers,overlays:[overlay],controls:[zoom],target:"mapplay",view:view,loadTilesWhileAnimating:!0,loadTilesWhileInteracting:!0});if(map.addInteraction(select),renew_source(!1,!0),interval=setInterval((()=>{renew_source(!1,!1)}),gameupdatetime),add_layergroup_to_list(layergroup),layersoverlay.forEach((overlay=>{add_layer_to_list(overlay)})),tracking&&user){let tracklayergroup=_viewgpx.default.addgpxlayer(map,cmid,treasurehuntid,strings,user,"trackgroup");tracklayergroup.set("name",tracklayergroup.get("title"));let tracklayer=tracklayergroup.getLayers().item(0),htmltitle=tracklayer.get("title");tracklayer.set("name",htmltitle),tracklayer.setVisible(!1),add_layer_to_list(tracklayer)}function validateposition(){playwithoutmoving&&!markerFeature.getGeometry()?toast(strings.nomarks):renew_source(!0,!1)}function autocentermap(){const position=geolocation.getPosition();position&&fly_to(map,position)}function fly_to(map,point,extent){let view=map.getView();extent&&extent[0]!==1/0?view.fit(extent,{duration:700}):point&&view.animate({zoom:defaultzoom,center:point,duration:700})}function renew_source(location,initialize,selectedanswerid,qrtext){let position,currentposition,markLocation,answerid;markLocation=markerFeature.getGeometry(),markLocation&&(currentposition=geoJSONFormat.writeGeometryObject(markLocation,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})),selectedanswerid&&(setLoading(!0),answerid=selectedanswerid),location&&(position=currentposition,setLoading(!0));let currentpositionarg=tracking&&!playwithoutmoving?currentposition:null,params={treasurehuntid:treasurehuntid,attempttimestamp:lastattempttimestamp,roadtimestamp:lastroadtimestamp,playwithoutmoving:playwithoutmoving,groupmode:groupmode,initialize:initialize,location:position,selectedanswerid:answerid,qoaremoved:qoaremoved,qrtext:qrtext};currentpositionarg&&(params.currentposition=currentpositionarg),_ajax.default.call([{methodname:"mod_treasurehunt_user_progress",args:{userprogress:params}}])[0].done((response=>{if(qoaremoved=response.qoaremoved,roadfinished=response.roadfinished,available=response.available,setLoading(!1),(location||selectedanswerid)&&null!==response.status&&available&&toast(response.status.msg),playwithoutmoving!=response.playwithoutmoving&&!(playwithoutmoving=response.playwithoutmoving)){geolocation.setTracking(!0);let position=positionFeature.getGeometry();position&&markerFeature.setGeometry(position)}groupmode!=response.groupmode&&(groupmode=response.groupmode),set_player_config(response.playerconfig);let nextstagefeatures=null;response&&response.nextstage&&(nextstagefeatures=geoJSONFormat.readFeatures(response.nextstage,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}));let newnextstagefeature=(nextstagefeatures&&nextstagefeatures[0])??null,stagepositionold=nextstagefeature?nextstagefeature.get("stageposition"):null,stagepositionnew=newnextstagefeature?newnextstagefeature.get("stageposition"):null;isfirststage=newnextstagefeature&&1===newnextstagefeature.get("stageposition");let isfirstload=null===nextstagefeature;if(null!==newnextstagefeature&&(null===nextstagefeature||stagepositionold!=stagepositionnew)){nextstagefeature=newnextstagefeature,stageSource.clear(),isfirststage||customplayerconfig.shownextareahint?nextstagefeature.set("shouldrender",!0):nextstagefeature.set("shouldrender",!1),nextstagefeature.set("is_stage",!0),stageSource.addFeatures([nextstagefeature]),!0===isfirststage&&(isfirstload||initialize)&&(fitmap=!0,fit_map_to_sources([stageSource]))}if(lastattempttimestamp===response.attempttimestamp&&lastroadtimestamp===response.roadtimestamp&&!initialize&&available||(lastattempttimestamp=response.attempttimestamp,lastroadtimestamp=response.roadtimestamp,response.attempthistory.length>0&&(attemptshistory=response.attempthistory,changesinattemptshistory=!0),response.attempts&&response.attempts.features.length>0&&response.attempts.features.length>0&&(attemptSource.clear(),attemptSource.addFeatures(geoJSONFormat.readFeatures(response.attempts,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))),response.lastsuccessfulstage&&(lastsuccessfulstage=response.lastsuccessfulstage,changesinlastsuccessfulstage=!0,openModal("#cluepage"),$("#validateqr").hide(),""!==lastsuccessfulstage.question?(changesinquestionstage=!0,$("#validatelocation").hide()):lastsuccessfulstage.activitysolved?($("#validatelocation").show(),response.qrexpected&&$("#validateqr").show()):$("#validatelocation").hide()),(!response.lastsuccessfulstage&&isfirststage||initialize)&&(fitmap=!0,fit_map_to_sources(isfirststage&&isfirstload?[stageSource]:[attemptSource])),apply_lastsuccessfulstage(),set_question(),set_attempts_history()),response.infomsg.length>0){let body="";infomsgs.forEach((msg=>{body+="<p>"+msg+"</p>"})),response.infomsg.forEach((msg=>{infomsgs.push(msg),body+="<p>"+msg+"</p>"})),$("#notificationsPopup .update-list").html(body),openModal("#notificationsPopup"),$("#notificationsPopup").on("modal:close",(function(){openModal("#cluepage")}))}roadfinished||$("#roadended").hide(),!roadfinished&&available||($("#validatelocation").hide(),$("#question_button").hide(),$("#roadended").show(),playwithoutmoving=!1,clearInterval(interval),$("#mapplay").css("opacity","0.8"))})).fail((error=>{let message;message="generalexceptionmessage"===error.errorcode?"System Error: "+error.error:strings.webserviceerror+" : "+error.error,$("#errorPopup .play-modal-content").text(message),openModal("#errorPopup")}))}function set_player_config(playerconfig){playerconfig?(customplayerconfig=Object.assign(customplayerconfig||{},playerconfig),1==customplayerconfig.searchpaneldisabled?$("#searchbutton").hide():$("#searchbutton").show(),1==customplayerconfig.localizationbuttondisabled?$("#autolocate").hide():usegeographictools&&$("#autolocate").show()):customplayerconfig={searchpaneldisabled:!1,localizationbuttondisabled:!1,showdistancehint:!1,showheadinghint:!1,showinzonehint:!1,shownextareahint:!1,defaultzoom:15}}function fit_map_to_sources(sources){if(fitmap){let extent=_ol.default.extent.createEmpty();sources.forEach((source=>{extent=_ol.default.extent.extend(extent,source.getExtent())}));let size=extent[2]-extent[0],p=[(extent[0]+extent[2])/2,(extent[1]+extent[3])/2];extent[0]!==1/0&&size>0?(extent=_ol.default.extent.buffer(extent,.25*size),fly_to(map,null,extent)):fly_to(map,p),fitmap=!1}}function apply_lastsuccessfulstage(){changesinlastsuccessfulstage&&(lastsuccessfulstage.clue=lastsuccessfulstage.clue.replace(/color/gm,"color-disabled"),$("#lastsuccessfulstageclue").html(lastsuccessfulstage.clue),$("#lastsuccessfulstagename").text(lastsuccessfulstage.name),$("#lastsuccesfulstagepos").text(lastsuccessfulstage.position+" / "+lastsuccessfulstage.totalnumber),""!==lastsuccessfulstage.question?$("#questionbutton").show():$("#questionbutton").hide(),changesinlastsuccessfulstage=!1)}function set_question(){if(changesinquestionstage){lastsuccessfulstage.question=lastsuccessfulstage.question.replace(/color/gm,"color-disabled"),$("#questionform").html("<legend>"+lastsuccessfulstage.question+"</legend>");let counter=1;$.each(lastsuccessfulstage.answers,((key,answer)=>{let id="answer"+counter;answer.answertext=answer.answertext.replace(/color/gm,"color-disabled"),$("#questionform").append(`<div class="form-check">\n                <input class="form-check-input" type="radio" name="answers" id="${id}" value="${answer.id}">\n                <label class="form-check-label" for="${id}">\n                  ${answer.answertext}\n                </label>\n            </div>`),counter++})),changesinquestionstage=!1}}function set_attempts_history(){if(changesinattemptshistory){let $historylist=$("#historylist");$historylist.html(""),changesinattemptshistory=!1,0===attemptshistory.length?$("<li>"+strings.noattempts+"</li>").appendTo($historylist):attemptshistory.forEach((attempt=>{$("<li><span class='ui-btn-icon-left "+(attempt.penalty?"ui-icon-delete failedattempt":"ui-icon-check successfulattempt")+"' style='position:relative'></span>"+attempt.string+"</li>").appendTo($historylist)}))}}function add_layer_to_list(layer){let link=$("<button>",{type:"button",class:"list-group-item list-group-item-action close-modal"}).click((()=>{layer.setVisible(!layer.getVisible())})),name=$("<div>").append($.parseHTML(layer.get("name"))),checkboxContent=$("<i>",{class:"fa fa-check-circle"+(layer.getVisible()?"":" unchecked")}),linkContent=$("<div>",{class:"layer-item"}).append(name,checkboxContent);link.append(linkContent),layer.on("change:visible",(()=>{$(checkboxContent).toggleClass("unchecked")})),$("#layerslist").prepend(link)}function add_layergroup_to_list(layergroup){layergroup.getLayers().forEach((layer=>{let link=$("<button>",{type:"button",class:"list-group-item list-group-item-action close-modal"}).click((()=>{layergroup.getLayers().forEach((l=>{l===layer?l.setVisible(!0):l.setVisible(!1)}))})),checkboxContent=$("<i>",{class:"fa fa-check-circle"+(layer.getVisible()?"":" unchecked")}),linkContent=$("<div>",{text:layer.get("name"),class:"layer-item "}).append(checkboxContent);link.append(linkContent),layer.on("change:visible",(()=>{$(checkboxContent).toggleClass("unchecked")})),$("#layerslist").prepend(link)}))}let geolocation=new _ol.default.Geolocation({projection:view.getProjection(),trackingOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}});function toast(msg){const toast=$(`<div class='play-toast slide-in-bottom'>${msg}</div>`);toast.appendTo($(".play-toast-container")),setTimeout((()=>toast.addClass("slide-out-top")),3e3),setTimeout((()=>toast.remove()),3500)}function openModal(id){closeModal();const modal=$(id);modal.addClass("active"),$(`${id} .modal-mask`).addClass("active dismissible"),modal.trigger("modal:open")}function closeModal(){const modals=$(".play-modal.active");modals.removeClass("active"),$(".modal-mask").removeClass("active dismissible"),modals.each(((index,modal)=>{$(modal).trigger("modal:close")}))}function get_block_text(title,body){return`<div class="card">\n          <div class="card-body">\n            <h5 class="card-title">${title}</h5>\n            <h6 class="card-subtitle text-muted">${body}</h6>\n          </div>\n      </div>`}function closeSidePanel(id){$(id).removeClass("active"),$(".sidebar-mask").removeClass("active dismissible")}function setLoading(loading){loading?$(".global-loader").addClass("active"):$(".global-loader").removeClass("active")}function calculateHeading(start,end){let closestPoint=end.getClosestPoint(start.getCoordinates()),deltaX=closestPoint[0]-start.getCoordinates()[0],deltaY=closestPoint[1]-start.getCoordinates()[1],heading=Math.atan2(deltaY,deltaX);return heading<0&&(heading+=2*Math.PI),-heading+Math.PI/2}function qrReaded(value){closeModal(),toast("QR code readed: "+value),renew_source(!1,!1,null,value)}function qrReport(message){"string"==typeof message?$("#errorQR").text(message):(null!==message.cameras[message.camera].name&&$("#errorQR").text(message.cameras[message.camera].name),message.cameras.length>1?$("#nextcamera").show():$("#nextcamera").hide())}geolocation.on("change:position",(()=>{let coordinates=geolocation.getPosition();coordinates?(geolocation.set("user_denied",!1),positionFeature.setGeometry(coordinates?new _ol.default.geom.Point(coordinates):null),0==playwithoutmoving&&coordinates&&markerFeature.setGeometry(new _ol.default.geom.Point(coordinates)),closeModal(),geolocation.get("center")&&(fly_to(map,coordinates),geolocation.setProperties({center:!1})),geolocation.get("validate_location")&&(renew_source(!0,!1),geolocation.setProperties({validate_location:!1}))):(0,_str.get_string)("geolocation_problem","mod_treasurehunt").then((msg=>{toast(msg)}))})),geolocation.on("change:accuracyGeometry",(()=>{accuracyFeature.setGeometry(geolocation.getAccuracyGeometry())})),geolocation.on("error",(error=>{1==error.code?geolocation.set("user_denied",!0):geolocation.set("user_denied",!1),(0,_str.get_string)("geolocation_problem","mod_treasurehunt").then((msg=>{toast(msg+": "+error.message)})),1==error.code&&tracking&&!playwithoutmoving&&Promise.resolve().then((()=>{openModal("#geolocationPopup")})),tracking&&!playwithoutmoving&&setTimeout((()=>{geolocation.setTracking(!0)}),1e4)})),geolocation.setTracking(!0),supportsTouch||map.on("pointermove",(evt=>{if(evt.dragging)return;const pixel=map.getEventPixel(evt.originalEvent);let hit=!1;map.forEachFeatureAtPixel(pixel,(feature=>{feature.getGeometry()instanceof _ol.default.geom.MultiPolygon||(hit=!0)}),{layerFilter:layer=>layer===attemptslayer||layer===stagelayer}),map.getTargetElement().style.cursor=hit?"pointer":"crosshair"})),select.on("select",(features=>{if(1===features.selected.length){let stagename=features.selected[0].get("name"),stageclue=features.selected[0].get("clue"),info=features.selected[0].get("info"),body="",title="";info&&(body="<p>"+info+"</p>"),features.selected[0].get("geometrysolved")?stagename&&stageclue?(title=strings.stageovercome,body+=get_block_text(strings.stagename,stagename),body+=get_block_text(strings.stageclue,stageclue)):title=strings.discoveredlocation:title=strings.failedlocation,$("#infoStagePopup .title").text(title),$("#infoStagePopup .play-modal-content").html(body),openModal("#infoStagePopup")}})),map.on("click",(evt=>{let hasFeature=!1;if(map.forEachFeatureAtPixel(map.getEventPixel(evt.originalEvent),(feature=>{if(!0===feature.get("is_stage")||"user_position"===feature.get("name")||"user_accuracy"===feature.get("name"))return!1;hasFeature=!0})),playwithoutmoving&&!hasFeature){let coordinates=map.getEventCoordinate(evt.originalEvent);markerFeature.setGeometry(coordinates?new _ol.default.geom.Point(coordinates):null),(null===custommapconfig||custommapconfig.geographic)&&overlay.setPosition(evt.coordinate)}})),$("#searchInput").on("input",(ev=>{osmGeocoderXHR&&osmGeocoderXHR.abort(),osmTimer&&clearTimeout(osmTimer);const $searchContainer=$("#searchsResults"),value=ev.target.value;$searchContainer.html(""),value&&value.length>2&&($(".search-loading").addClass("active"),osmTimer=setTimeout((()=>{osmGeocoderXHR=_osmGeocoder.default.search(value).done((resp=>{$(".search-loading").removeClass("active"),0===resp.length?$searchContainer.html("<li class='list-group-item'>"+strings.noresults+"</li>"):$.each(resp,((i,place)=>{let link=$("<button>",{type:"button",class:"list-group-item list-group-item-action"}).appendTo($searchContainer).click((()=>{let extent=[];extent[0]=parseFloat(place.boundingbox[2]),extent[1]=parseFloat(place.boundingbox[0]),extent[2]=parseFloat(place.boundingbox[3]),extent[3]=parseFloat(place.boundingbox[1]),extent=_ol.default.proj.transformExtent(extent,"EPSG:4326","EPSG:3857"),fly_to(map,null,extent),closeSidePanel("#searchpanel")})),linkContent=$("<div>",{text:place.display_name,class:"search-option"}).append($("<i class='fa fa-chevron-circle-right'>"));link.append(linkContent)}))})).fail((()=>{})).always((()=>{osmGeocoderXHR=null}))}),400))})),$("#infoStagePopup").on("modal:close",(()=>{select.getFeatures().clear()})),$("#acceptupdates").on("click",(()=>{infomsgs=[]})),$("#qrpage").on("modal:open",(()=>{_webqr.default.loadQR(qrReaded,qrReport)})),$("#qrpage").on("modal:close",(()=>{_webqr.default.unloadQR(qrReport)})),$("#nextcamera").on("click",(()=>{let detectedCameras=_webqr.default.getDetectedCameras();if(null!==detectedCameras){toast("Give access to:"+detectedCameras[_webqr.default.getnextwebCam()].name)}_webqr.default.setnextwebcam(qrReport)})),$(window).on("resize",(()=>{map.updateSize()})),$("#fitmap").on("click",(()=>{let attentionSources=[attemptSource,markerSource];usegeographictools&&attentionSources.push(userPositionSource),(customplayerconfig.shownextareahint||isfirststage)&&attentionSources.push(stageSource),fitmap=!0,fit_map_to_sources(attentionSources)})),usegeographictools&&$("#autolocate").on("click",(()=>{geolocation.setTracking(!0),geolocation.get("user_denied")?openModal("#geolocationPopup"):Promise.resolve().then((()=>{autocentermap()}))})),$("#infopanel").on("sidebar:close",(()=>{select.getFeatures().clear()})),$("#sendLocation").on("click",(()=>{validateposition()})),$("#sendAnswer").on("click",(event=>{let selected=$("#questionform input[type='radio']:checked");available?0===selected.length?(event.preventDefault(),toast(strings.noanswerselected)):renew_source(!1,!1,selected.val()):(event.preventDefault(),toast(strings.timeexceeded))})),$("#validatelocation").on("click",(event=>roadfinished?(event.preventDefault(),void toast(strings.huntcompleted)):available?""!==lastsuccessfulstage.question?(event.preventDefault(),toast(strings.answerwarning),void openModal("#cluepage")):lastsuccessfulstage.activitysolved?void 0:(event.preventDefault(),toast(strings.activitytoendwarning),void openModal("#cluepage")):(event.preventDefault(),void toast(strings.timeexceeded)))),$(document).on("click",'*[data-rel="sidebar"]',(e=>{const target=e.currentTarget,sidebar=$(target.dataset.ref);sidebar.trigger("sidebar:open"),sidebar.addClass("active"),null!==target.dataset.dismissible&&$(".sidebar-mask").addClass("active dismissible")})),$(document).on("click",".close-sidebar, .sidebar-mask",(()=>{const sidebars=$(".sidebar.active");sidebars.trigger("sidebar:close"),sidebars.removeClass("active"),$(".sidebar-mask").removeClass("active dismissible")})),$(document).on("click",'*[data-rel="modal"]',(e=>{closeModal();const target=e.currentTarget,modal=$(target.dataset.ref);modal.trigger("modal:open"),modal.addClass("active"),$(target.dataset.ref+" .modal-mask").addClass("active"),null!==target.dataset.dismissible&&$(target.dataset.ref+" .modal-mask").addClass("dismissible")})),$(document).on("click",".close-modal, .modal-mask.dismissible",(()=>{closeModal()}))}var _default=init;return _exports.default=_default,_exports.default}));

//# sourceMappingURL=play_bootstrap.min.js.map